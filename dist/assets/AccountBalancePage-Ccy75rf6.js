import{c as P,r as o,u as G,e as $,j as e,d as z,i as J,a as S,U as W,h as Y}from"./index-CQo2C1RI.js";import{u as L}from"./useMutation-EETARgQ6.js";import{A as Z}from"./arrow-left-BTsKc74L.js";import{C as B}from"./circle-check-big-Ch9gMs3h.js";import{X as ee}from"./x-BBUXgrGO.js";import{L as T}from"./loader-circle-b0cw_qG-.js";import{T as te}from"./triangle-alert-Q-0b95mK.js";import{D as se}from"./dollar-sign-DTHsBWDG.js";const ae=[["path",{d:"M6 22a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h8a2.4 2.4 0 0 1 1.704.706l3.588 3.588A2.4 2.4 0 0 1 20 8v12a2 2 0 0 1-2 2z",key:"1oefj6"}],["path",{d:"M14 2v5a1 1 0 0 0 1 1h5",key:"wfsgrz"}],["path",{d:"M9 15h6",key:"cctwl0"}],["path",{d:"M12 18v-6",key:"17g6i2"}]],R=P("file-plus",ae);const re=[["path",{d:"M6 22a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h8a2.4 2.4 0 0 1 1.704.706l3.588 3.588A2.4 2.4 0 0 1 20 8v12a2 2 0 0 1-2 2z",key:"1oefj6"}],["path",{d:"M14 2v5a1 1 0 0 0 1 1h5",key:"wfsgrz"}],["path",{d:"M10 9H8",key:"b1mrlr"}],["path",{d:"M16 13H8",key:"t4e002"}],["path",{d:"M16 17H8",key:"z1uh3a"}]],ne=P("file-text",re);const ie=[["path",{d:"M3 5h.01",key:"18ugdj"}],["path",{d:"M3 12h.01",key:"nlz23k"}],["path",{d:"M3 19h.01",key:"noohij"}],["path",{d:"M8 5h13",key:"1pao27"}],["path",{d:"M8 12h13",key:"1za7za"}],["path",{d:"M8 19h13",key:"m83p4d"}]],le=P("list",ie),x=n=>new Intl.NumberFormat("es-AR",{style:"currency",currency:"ARS"}).format(n||0),ce=({adminUser:n,onClose:f,onSuccess:g})=>{const[c,_]=o.useState(""),[v,b]=o.useState(""),[y,w]=o.useState([]),[C,E]=o.useState(""),[j,m]=o.useState(""),[u,N]=o.useState([]),[p,h]=o.useState(""),[s,k]=o.useState(new Map),U=J(),I=L({mutationFn:S.fetchCustomerInvoicesApi,onSuccess:t=>{t.length===0?(m("No se encontraron facturas (débitos) con pedidos asociados para este cliente."),w([])):(w(t),m(""))},onError:t=>{m(t.message||"Error al buscar facturas."),w([])}}),F=L({mutationFn:S.fetchAdminOrderDetailApi,onSuccess:t=>{N(t.items||[]),h(""),k(new Map)},onError:t=>{h(t.message||"Error al cargar los items de la factura."),N([])}}),i=L({mutationFn:S.createCreditNoteApi,onSuccess:t=>{U.invalidateQueries({queryKey:["accountBalance",n.id]}),g(t.message||"Nota de crédito creada con éxito.")}}),Q=()=>{if(!c.trim()){m("Debe ingresar un Nº de Cliente.");return}m(""),E(""),b(""),N([]),k(new Map),I.mutate({customerCod:c})},O=t=>{const r=t.target.value;if(E(r),N([]),k(new Map),h(""),r){const a=y.find(l=>l.id.toString()===r);a&&a.order_ref&&(F.mutate({orderId:a.order_ref}),b(`Devolución/Anulación ref. Factura: ${a.comprobante}`))}else b("")},V=(t,r)=>{const a=parseInt(r,10),l=new Map(s);if(isNaN(a)||a<=0)l.delete(t.product_id);else{const M=Math.min(a,t.quantity);l.set(t.product_id,M)}k(l)},H=(t,r)=>{const a=new Map(s);r?a.set(t.product_id,t.quantity):a.delete(t.product_id),k(a)},A=o.useMemo(()=>{let t=0;for(const[r,a]of s.entries()){const l=u.find(M=>M.product_id===r);l&&(t+=l.unit_price*a)}return t},[s,u]),K=t=>{if(t.preventDefault(),i.reset(),!c.trim()){i.error=new Error("El Nº de Cliente (A1_COD) es obligatorio.");return}if(!C){i.error=new Error("Debe seleccionar una factura de referencia.");return}if(s.size===0){i.error=new Error("Debe seleccionar al menos un producto para la nota de crédito.");return}if(!v.trim()){i.error=new Error("Debe ingresar un concepto.");return}const r=y.find(l=>l.id.toString()===C);if(!r){i.error=new Error("Error interno: No se encontró la factura seleccionada.");return}const a=[];for(const[l,M]of s.entries()){const D=u.find(X=>X.product_id===l);D&&a.push({product_id:D.product_id,quantity:M,unit_price:D.unit_price})}i.mutate({targetUserCod:c.trim(),reason:v.trim(),items:a,invoiceRefId:r.id})},d=i.isPending||I.isPending||F.isPending;return e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-60 backdrop-blur-sm",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-2xl w-full max-w-2xl m-4 max-h-[90vh] flex flex-col",children:[e.jsxs("div",{className:"flex-shrink-0 flex items-center justify-between p-5 border-b border-gray-200",children:[e.jsxs("h3",{className:"text-xl font-semibold text-gray-800 flex items-center",children:[e.jsx(R,{className:"w-6 h-6 mr-3 text-green-600"}),"Crear Nota de Crédito"]}),e.jsx("button",{onClick:f,disabled:d,className:"p-2 text-gray-400 rounded-full hover:bg-gray-200 hover:text-gray-600 transition-colors",children:e.jsx(ee,{className:"w-5 h-5"})})]}),e.jsxs("form",{onSubmit:K,className:"flex-1 flex flex-col overflow-hidden",children:[e.jsxs("div",{className:"flex-1 p-6 space-y-5 overflow-y-auto",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"targetUserCod",className:"block text-sm font-medium text-gray-700 mb-1",children:"Nº de Cliente (A1_COD)"}),e.jsxs("div",{className:"flex space-x-2",children:[e.jsxs("div",{className:"relative flex-grow",children:[e.jsx(W,{className:"w-5 h-5 text-gray-400 absolute left-3 top-1/2 -translate-y-1/2"}),e.jsx("input",{id:"targetUserCod",type:"text",value:c,onChange:t=>_(t.target.value),placeholder:"Ej: 000123",className:"w-full pl-10 pr-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500",disabled:d})]}),e.jsxs("button",{type:"button",onClick:Q,disabled:d||!c,className:"inline-flex items-center justify-center px-4 py-2.5 bg-blue-600 text-white font-medium rounded-lg shadow-sm hover:bg-blue-700 transition-colors disabled:opacity-50",children:[I.isPending?e.jsx(T,{className:"w-5 h-5 animate-spin"}):e.jsx(Y,{className:"w-5 h-5"}),e.jsx("span",{className:"ml-2 hidden sm:inline",children:"Buscar Facturas"})]})]})]}),(y.length>0||j)&&e.jsxs("div",{children:[e.jsx("label",{htmlFor:"invoiceSelect",className:"block text-sm font-medium text-gray-700 mb-1",children:"Seleccionar Factura"}),e.jsxs("div",{className:"relative",children:[e.jsx(le,{className:"w-5 h-5 text-gray-400 absolute left-3 top-1/2 -translate-y-1/2"}),e.jsxs("select",{id:"invoiceSelect",value:C,onChange:O,className:"w-full pl-10 pr-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 bg-white",disabled:d,children:[e.jsx("option",{value:"",children:"-- Seleccionar una factura --"}),y.map(t=>e.jsx("option",{value:t.id,children:`${new Date(t.date).toLocaleDateString("es-AR")} - ${t.comprobante} - ${x(t.importe)}`},t.id))]})]}),j&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:j})]}),F.isPending&&e.jsxs("div",{className:"flex justify-center items-center p-4",children:[e.jsx(T,{className:"w-6 h-6 animate-spin text-blue-600"}),e.jsx("span",{className:"ml-2 text-gray-600",children:"Cargando productos de la factura..."})]}),p&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:p}),u.length>0&&e.jsxs("div",{className:"space-y-3 border border-gray-200 rounded-lg p-4",children:[e.jsx("h4",{className:"text-md font-semibold text-gray-800 mb-3",children:"Productos en la Factura"}),e.jsx("div",{className:"max-h-48 overflow-y-auto space-y-3 pr-2",children:u.map(t=>e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("input",{type:"checkbox",id:`item-${t.product_id}`,className:"h-5 w-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500",checked:s.has(t.product_id),onChange:r=>H(t,r.target.checked),disabled:d}),e.jsxs("label",{htmlFor:`item-${t.product_id}`,className:"flex-1 text-sm text-gray-700",children:[t.product_name," (",x(t.unit_price),")"]}),e.jsx("input",{type:"number",min:"1",max:t.quantity,value:s.get(t.product_id)||"",onChange:r=>V(t,r.target.value),disabled:!s.has(t.product_id)||d,className:"w-20 px-2 py-1 border border-gray-300 rounded-md text-sm disabled:bg-gray-100 disabled:text-gray-400",placeholder:`Max: ${t.quantity}`})]},t.product_id))})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"reason",className:"block text-sm font-medium text-gray-700 mb-1",children:"Concepto / Motivo"}),e.jsxs("div",{className:"relative",children:[e.jsx(ne,{className:"w-5 h-5 text-gray-400 absolute left-3 top-3.5"}),e.jsx("textarea",{id:"reason",rows:"2",value:v,onChange:t=>b(t.target.value),placeholder:"Ej: Devolución por falla",className:"w-full pl-10 pr-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500",disabled:d})]})]}),A>0&&e.jsxs("div",{className:"flex justify-between items-center p-3 bg-gray-100 rounded-lg",children:[e.jsx("span",{className:"text-lg font-semibold text-gray-800",children:"Total N/C:"}),e.jsx("span",{className:"text-2xl font-bold text-green-600",children:x(A)})]}),i.isError&&e.jsxs("div",{className:"flex items-center p-3 bg-red-100 text-red-700 rounded-lg",children:[e.jsx(te,{className:"w-5 h-5 mr-2 flex-shrink-0"}),e.jsx("span",{className:"text-sm",children:i.error.message})]})]}),e.jsxs("div",{className:"flex-shrink-0 flex items-center justify-end p-5 border-t border-gray-200 bg-gray-50 rounded-b-lg space-x-3",children:[e.jsx("button",{type:"button",onClick:f,disabled:d,className:"px-5 py-2.5 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-100 transition-colors disabled:opacity-50",children:"Cancelar"}),e.jsxs("button",{type:"submit",disabled:d||A<=0,className:"inline-flex items-center justify-center px-5 py-2.5 text-sm font-medium text-white bg-green-600 rounded-lg shadow-sm hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed",children:[i.isPending?e.jsx(T,{className:"w-5 h-5 mr-2 animate-spin"}):e.jsx(B,{className:"w-5 h-5 mr-2"}),i.isPending?"Creando...":"Confirmar N/C"]})]})]})]})})},oe=()=>e.jsxs("div",{className:"animate-pulse",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6 mb-8",children:[e.jsx("div",{className:"bg-gray-200 h-32 rounded-lg"}),e.jsx("div",{className:"bg-gray-200 h-32 rounded-lg"}),e.jsx("div",{className:"bg-gray-200 h-32 rounded-lg"})]}),e.jsx("div",{className:"bg-gray-200 h-64 rounded-lg"})]}),de=({message:n})=>e.jsxs("div",{className:"flex flex-col items-center justify-center p-10 bg-white rounded-lg shadow-md",children:[e.jsx("p",{className:"text-red-500 font-semibold text-lg",children:"Error al cargar el balance"}),e.jsx("p",{className:"text-gray-600 mt-2",children:n}),e.jsx("p",{className:"text-gray-500 text-sm mt-4",children:"Por favor, intente recargar la página o contacte a soporte."})]}),q=({title:n,amount:f,bgColorClass:g})=>{const c=(f||0).toLocaleString("es-AR",{style:"currency",currency:"ARS"});return e.jsxs("div",{className:"bg-white p-6 rounded-lg shadow-md border-l-4 border-blue-500",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h3",{className:"text-sm font-medium text-gray-500 uppercase tracking-wider",children:n}),e.jsx(se,{className:"w-6 h-6 text-gray-400"})]}),e.jsx("p",{className:`text-3xl font-bold ${g}`,children:c})]})};function ye({user:n}){const[f,g]=o.useState(!1),[c,_]=o.useState(""),v=G(),{data:b,isLoading:y,isError:w,error:C}=$({queryKey:["accountBalance",n?.id],queryFn:()=>S.fetchAccountBalance(),enabled:!!n?.id,staleTime:1e3*60*2}),{data:E,isLoading:j,isError:m,error:u}=$({queryKey:["accountMovements",n?.id],queryFn:()=>S.fetchAccountMovements(),enabled:!!n?.id,staleTime:1e3*60*2}),N=s=>{_(s),g(!1),setTimeout(()=>_(""),3e3)},p=b?.balance||{total:0,disponible:0,pendiente:0},h=E||[];if(y)return e.jsx(oe,{});if(w){const s=n?.id?C.message:"No se ha podido identificar al usuario.";return e.jsx(de,{message:s})}return e.jsxs(e.Fragment,{children:[f&&e.jsx(ce,{adminUser:n,onClose:()=>g(!1),onSuccess:N}),e.jsxs("div",{className:"p-6 bg-gray-50 min-h-screen",children:[e.jsxs("header",{className:"mb-8 flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx("button",{onClick:()=>v("/dashboard"),className:"flex items-center justify-center p-2 mr-4 text-gray-600 bg-white rounded-full shadow-md hover:bg-gray-100 transition-colors","aria-label":"Volver al dashboard",children:e.jsx(Z,{className:"w-6 h-6"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-800",children:"Mi Cuenta Corriente"}),e.jsx("p",{className:"text-gray-600",children:"Resumen de saldos y últimos movimientos."})]})]}),n?.is_admin&&e.jsxs("button",{onClick:()=>g(!0),className:"inline-flex items-center px-4 py-2 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 transition-colors",children:[e.jsx(R,{className:"w-5 h-5 mr-2"}),"Crear Nota de Crédito"]})]}),c&&e.jsxs("div",{className:"mb-6 flex items-center p-4 bg-green-100 text-green-700 rounded-lg shadow-md",children:[e.jsx(B,{className:"w-5 h-5 mr-3 flex-shrink-0"}),e.jsx("span",{className:"text-sm font-medium",children:c})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4 md:gap-6 mb-8",children:[e.jsx(q,{title:"Saldo Total",amount:p.total,bgColorClass:p.total>=0?"text-green-600":"text-red-600"}),e.jsx(q,{title:"Disponible",amount:p.disponible,bgColorClass:"text-green-600"}),e.jsx(q,{title:"Pendiente de Imputación",amount:p.pendiente,bgColorClass:"text-yellow-600"})]}),e.jsxs("section",{children:[e.jsx("h2",{className:"text-2xl font-semibold text-gray-700 mb-4",children:"Detalle de Movimientos"}),e.jsx("div",{className:"md:hidden space-y-4",children:j?e.jsx("div",{className:"flex justify-center py-8",children:e.jsx(z,{text:"Cargando movimientos..."})}):m?e.jsxs("div",{className:"p-4 bg-red-100 text-red-700 rounded-lg",children:["Error: ",u.message]}):h.length>0?h.map(s=>e.jsxs("div",{className:"bg-white p-4 rounded-lg shadow-sm border border-gray-100",children:[e.jsxs("div",{className:"flex justify-between items-start mb-2",children:[e.jsxs("div",{children:[e.jsx("span",{className:"block font-bold text-gray-800 text-sm",children:s.titulo_num||"S/N"}),e.jsxs("span",{className:"text-xs text-gray-500",children:["Emisión: ",s.formatted_date]})]}),e.jsxs("span",{className:"text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded",children:["Vence: ",s.formatted_fecha_vencimiento||"-"]})]}),e.jsxs("div",{className:"flex justify-between items-center mt-3 pt-3 border-t border-gray-50",children:[e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-xs text-gray-500 uppercase",children:"Importe"}),s.debit>0?e.jsxs("span",{className:"font-bold text-red-600",children:["- ",x(s.debit)]}):e.jsxs("span",{className:"font-bold text-green-600",children:["+ ",x(s.credit)]})]}),e.jsxs("div",{className:"flex flex-col items-end",children:[e.jsx("span",{className:"text-xs text-gray-500 uppercase",children:"Saldo"}),e.jsx("span",{className:"font-bold text-gray-800",children:x(s.balance)})]})]})]},s.id)):e.jsx("div",{className:"p-8 text-center bg-white rounded-lg text-gray-500",children:"No se registraron movimientos."})}),e.jsx("div",{className:"hidden md:block bg-white rounded-lg shadow-md overflow-hidden",children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full bg-white",children:[e.jsx("thead",{className:"bg-gray-100 border-b border-gray-300",children:e.jsxs("tr",{children:[e.jsx("th",{className:"py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider",children:"Num. Titulo"}),e.jsx("th",{className:"py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider",children:"Fch Emision"}),e.jsx("th",{className:"py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider",children:"Fch. de Vencimien."}),e.jsx("th",{className:"py-3 px-4 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider",children:"Debitos"}),e.jsx("th",{className:"py-3 px-4 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider",children:"Creditos"}),e.jsx("th",{className:"py-3 px-4 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider",children:"Saldo Acumulados"}),e.jsx("th",{className:"py-3 px-4 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider",children:"% Canc."}),e.jsx("th",{className:"py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider",children:"N° Recibo"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-200",children:j?e.jsx("tr",{children:e.jsx("td",{colSpan:"8",className:"py-6 px-4 text-center text-gray-500",children:e.jsx("div",{className:"flex justify-center items-center p-0",children:e.jsx(z,{text:"Cargando movimientos..."})})})}):m?e.jsx("tr",{children:e.jsxs("td",{colSpan:"8",className:"py-6 px-4 text-center text-red-500",children:["Error al cargar los movimientos:"," ",u.message]})}):h.length>0?h.map(s=>e.jsxs("tr",{className:"hover:bg-gray-50",children:[e.jsx("td",{className:"py-3 px-4 text-sm text-gray-700",children:s.titulo_num||"-"}),e.jsx("td",{className:"py-3 px-4 text-sm text-gray-700",children:s.formatted_date}),e.jsx("td",{className:"py-3 px-4 text-sm text-gray-700",children:s.formatted_fecha_vencimiento||"-"}),e.jsx("td",{className:"py-3 px-4 text-sm font-semibold text-right text-red-600",children:s.debit?x(s.debit):"-"}),e.jsx("td",{className:"py-3 px-4 text-sm font-semibold text-right text-green-600",children:s.credit?x(s.credit):"-"}),e.jsx("td",{className:"py-3 px-4 text-sm font-bold text-right text-gray-800",children:x(s.balance)}),e.jsx("td",{className:"py-3 px-4 text-sm text-right text-gray-700",children:s.porc_cancelado?`${s.porc_cancelado}%`:"-"}),e.jsx("td",{className:"py-3 px-4 text-sm text-gray-600",children:s.order_ref||"-"})]},s.id)):e.jsx("tr",{children:e.jsx("td",{colSpan:"8",className:"py-6 px-4 text-center text-gray-500",children:"No se registraron movimientos."})})})]})})})]})]})]})}export{ye as default};
