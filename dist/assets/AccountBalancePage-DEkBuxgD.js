import{u as X,c as P,j as e,L as B,f as G,a as E}from"./index-425XPhkP.js";import{r as d,A as J,y as R,t as $,X as W,U as Y,w as T,S as Z,E as ee,H as te,T as se,D as re}from"./ui-libs-xkhqbQ7p.js";import{u as q}from"./useMutation-D8chnLoC.js";import"./vendor-qkC6yhPU.js";const x=n=>new Intl.NumberFormat("es-AR",{style:"currency",currency:"ARS"}).format(n||0),ae=({adminUser:n,onClose:b,onSuccess:h})=>{const[c,M]=d.useState(""),[v,f]=d.useState(""),[y,w]=d.useState([]),[C,k]=d.useState(""),[j,m]=d.useState(""),[u,N]=d.useState([]),[p,g]=d.useState(""),[s,S]=d.useState(new Map),U=G(),I=q({mutationFn:E.fetchCustomerInvoicesApi,onSuccess:t=>{t.length===0?(m("No se encontraron facturas (débitos) con pedidos asociados para este cliente."),w([])):(w(t),m(""))},onError:t=>{m(t.message||"Error al buscar facturas."),w([])}}),F=q({mutationFn:E.fetchAdminOrderDetailApi,onSuccess:t=>{N(t.items||[]),g(""),S(new Map)},onError:t=>{g(t.message||"Error al cargar los items de la factura."),N([])}}),i=q({mutationFn:E.createCreditNoteApi,onSuccess:t=>{U.invalidateQueries({queryKey:["accountBalance",n.id]}),h(t.message||"Nota de crédito creada con éxito.")}}),Q=()=>{if(!c.trim()){m("Debe ingresar un Nº de Cliente.");return}m(""),k(""),f(""),N([]),S(new Map),I.mutate({customerCod:c})},O=t=>{const a=t.target.value;if(k(a),N([]),S(new Map),g(""),a){const r=y.find(l=>l.id.toString()===a);r&&r.order_ref&&(F.mutate({orderId:r.order_ref}),f(`Devolución/Anulación ref. Factura: ${r.comprobante}`))}else f("")},K=(t,a)=>{const r=parseInt(a,10),l=new Map(s);if(isNaN(r)||r<=0)l.delete(t.product_id);else{const _=Math.min(r,t.quantity);l.set(t.product_id,_)}S(l)},V=(t,a)=>{const r=new Map(s);a?r.set(t.product_id,t.quantity):r.delete(t.product_id),S(r)},A=d.useMemo(()=>{let t=0;for(const[a,r]of s.entries()){const l=u.find(_=>_.product_id===a);l&&(t+=l.unit_price*r)}return t},[s,u]),z=t=>{if(t.preventDefault(),i.reset(),!c.trim()){i.error=new Error("El Nº de Cliente (A1_COD) es obligatorio.");return}if(!C){i.error=new Error("Debe seleccionar una factura de referencia.");return}if(s.size===0){i.error=new Error("Debe seleccionar al menos un producto para la nota de crédito.");return}if(!v.trim()){i.error=new Error("Debe ingresar un concepto.");return}const a=y.find(l=>l.id.toString()===C);if(!a){i.error=new Error("Error interno: No se encontró la factura seleccionada.");return}const r=[];for(const[l,_]of s.entries()){const D=u.find(H=>H.product_id===l);D&&r.push({product_id:D.product_id,quantity:_,unit_price:D.unit_price})}i.mutate({targetUserCod:c.trim(),reason:v.trim(),items:r,invoiceRefId:a.id})},o=i.isPending||I.isPending||F.isPending;return e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-60 backdrop-blur-sm",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-2xl w-full max-w-2xl m-4 max-h-[90vh] flex flex-col",children:[e.jsxs("div",{className:"flex-shrink-0 flex items-center justify-between p-5 border-b border-gray-200",children:[e.jsxs("h3",{className:"text-xl font-semibold text-gray-800 flex items-center",children:[e.jsx(R,{className:"w-6 h-6 mr-3 text-green-600"}),"Crear Nota de Crédito"]}),e.jsx("button",{onClick:b,disabled:o,className:"p-2 text-gray-400 rounded-full hover:bg-gray-200 hover:text-gray-600 transition-colors",children:e.jsx(W,{className:"w-5 h-5"})})]}),e.jsxs("form",{onSubmit:z,className:"flex-1 flex flex-col overflow-hidden",children:[e.jsxs("div",{className:"flex-1 p-6 space-y-5 overflow-y-auto",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"targetUserCod",className:"block text-sm font-medium text-gray-700 mb-1",children:"Nº de Cliente (A1_COD)"}),e.jsxs("div",{className:"flex space-x-2",children:[e.jsxs("div",{className:"relative flex-grow",children:[e.jsx(Y,{className:"w-5 h-5 text-gray-400 absolute left-3 top-1/2 -translate-y-1/2"}),e.jsx("input",{id:"targetUserCod",type:"text",value:c,onChange:t=>M(t.target.value),placeholder:"Ej: 000123",className:"w-full pl-10 pr-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500",disabled:o})]}),e.jsxs("button",{type:"button",onClick:Q,disabled:o||!c,className:"inline-flex items-center justify-center px-4 py-2.5 bg-blue-600 text-white font-medium rounded-lg shadow-sm hover:bg-blue-700 transition-colors disabled:opacity-50",children:[I.isPending?e.jsx(T,{className:"w-5 h-5 animate-spin"}):e.jsx(Z,{className:"w-5 h-5"}),e.jsx("span",{className:"ml-2 hidden sm:inline",children:"Buscar Facturas"})]})]})]}),(y.length>0||j)&&e.jsxs("div",{children:[e.jsx("label",{htmlFor:"invoiceSelect",className:"block text-sm font-medium text-gray-700 mb-1",children:"Seleccionar Factura"}),e.jsxs("div",{className:"relative",children:[e.jsx(ee,{className:"w-5 h-5 text-gray-400 absolute left-3 top-1/2 -translate-y-1/2"}),e.jsxs("select",{id:"invoiceSelect",value:C,onChange:O,className:"w-full pl-10 pr-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 bg-white",disabled:o,children:[e.jsx("option",{value:"",children:"-- Seleccionar una factura --"}),y.map(t=>e.jsx("option",{value:t.id,children:`${new Date(t.date).toLocaleDateString("es-AR")} - ${t.comprobante} - ${x(t.importe)}`},t.id))]})]}),j&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:j})]}),F.isPending&&e.jsxs("div",{className:"flex justify-center items-center p-4",children:[e.jsx(T,{className:"w-6 h-6 animate-spin text-blue-600"}),e.jsx("span",{className:"ml-2 text-gray-600",children:"Cargando productos de la factura..."})]}),p&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:p}),u.length>0&&e.jsxs("div",{className:"space-y-3 border border-gray-200 rounded-lg p-4",children:[e.jsx("h4",{className:"text-md font-semibold text-gray-800 mb-3",children:"Productos en la Factura"}),e.jsx("div",{className:"max-h-48 overflow-y-auto space-y-3 pr-2",children:u.map(t=>e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("input",{type:"checkbox",id:`item-${t.product_id}`,className:"h-5 w-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500",checked:s.has(t.product_id),onChange:a=>V(t,a.target.checked),disabled:o}),e.jsxs("label",{htmlFor:`item-${t.product_id}`,className:"flex-1 text-sm text-gray-700",children:[t.product_name," (",x(t.unit_price),")"]}),e.jsx("input",{type:"number",min:"1",max:t.quantity,value:s.get(t.product_id)||"",onChange:a=>K(t,a.target.value),disabled:!s.has(t.product_id)||o,className:"w-20 px-2 py-1 border border-gray-300 rounded-md text-sm disabled:bg-gray-100 disabled:text-gray-400",placeholder:`Max: ${t.quantity}`})]},t.product_id))})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"reason",className:"block text-sm font-medium text-gray-700 mb-1",children:"Concepto / Motivo"}),e.jsxs("div",{className:"relative",children:[e.jsx(te,{className:"w-5 h-5 text-gray-400 absolute left-3 top-3.5"}),e.jsx("textarea",{id:"reason",rows:"2",value:v,onChange:t=>f(t.target.value),placeholder:"Ej: Devolución por falla",className:"w-full pl-10 pr-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500",disabled:o})]})]}),A>0&&e.jsxs("div",{className:"flex justify-between items-center p-3 bg-gray-100 rounded-lg",children:[e.jsx("span",{className:"text-lg font-semibold text-gray-800",children:"Total N/C:"}),e.jsx("span",{className:"text-2xl font-bold text-green-600",children:x(A)})]}),i.isError&&e.jsxs("div",{className:"flex items-center p-3 bg-red-100 text-red-700 rounded-lg",children:[e.jsx(se,{className:"w-5 h-5 mr-2 flex-shrink-0"}),e.jsx("span",{className:"text-sm",children:i.error.message})]})]}),e.jsxs("div",{className:"flex-shrink-0 flex items-center justify-end p-5 border-t border-gray-200 bg-gray-50 rounded-b-lg space-x-3",children:[e.jsx("button",{type:"button",onClick:b,disabled:o,className:"px-5 py-2.5 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-100 transition-colors disabled:opacity-50",children:"Cancelar"}),e.jsxs("button",{type:"submit",disabled:o||A<=0,className:"inline-flex items-center justify-center px-5 py-2.5 text-sm font-medium text-white bg-green-600 rounded-lg shadow-sm hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed",children:[i.isPending?e.jsx(T,{className:"w-5 h-5 mr-2 animate-spin"}):e.jsx($,{className:"w-5 h-5 mr-2"}),i.isPending?"Creando...":"Confirmar N/C"]})]})]})]})})},ne=()=>e.jsxs("div",{className:"animate-pulse",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6 mb-8",children:[e.jsx("div",{className:"bg-gray-200 h-32 rounded-lg"}),e.jsx("div",{className:"bg-gray-200 h-32 rounded-lg"}),e.jsx("div",{className:"bg-gray-200 h-32 rounded-lg"})]}),e.jsx("div",{className:"bg-gray-200 h-64 rounded-lg"})]}),ie=({message:n})=>e.jsxs("div",{className:"flex flex-col items-center justify-center p-10 bg-white rounded-lg shadow-md",children:[e.jsx("p",{className:"text-red-500 font-semibold text-lg",children:"Error al cargar el balance"}),e.jsx("p",{className:"text-gray-600 mt-2",children:n}),e.jsx("p",{className:"text-gray-500 text-sm mt-4",children:"Por favor, intente recargar la página o contacte a soporte."})]}),L=({title:n,amount:b,bgColorClass:h})=>{const c=(b||0).toLocaleString("es-AR",{style:"currency",currency:"ARS"});return e.jsxs("div",{className:"bg-white p-6 rounded-lg shadow-md border-l-4 border-blue-500",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h3",{className:"text-sm font-medium text-gray-500 uppercase tracking-wider",children:n}),e.jsx(re,{className:"w-6 h-6 text-gray-400"})]}),e.jsx("p",{className:`text-3xl font-bold ${h}`,children:c})]})};function xe({user:n}){const[b,h]=d.useState(!1),[c,M]=d.useState(""),v=X(),{data:f,isLoading:y,isError:w,error:C}=P({queryKey:["accountBalance",n?.id],queryFn:()=>E.fetchAccountBalance(),enabled:!!n?.id,staleTime:1e3*60*2}),{data:k,isLoading:j,isError:m,error:u}=P({queryKey:["accountMovements",n?.id],queryFn:()=>E.fetchAccountMovements(),enabled:!!n?.id,staleTime:1e3*60*2}),N=s=>{M(s),h(!1),setTimeout(()=>M(""),3e3)},p=f?.balance||{total:0,disponible:0,pendiente:0},g=k||[];if(y)return e.jsx(ne,{});if(w){const s=n?.id?C.message:"No se ha podido identificar al usuario.";return e.jsx(ie,{message:s})}return e.jsxs(e.Fragment,{children:[b&&e.jsx(ae,{adminUser:n,onClose:()=>h(!1),onSuccess:N}),e.jsxs("div",{className:"p-6 bg-gray-50 min-h-screen",children:[e.jsxs("header",{className:"mb-8 flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx("button",{onClick:()=>v("/dashboard"),className:"flex items-center justify-center p-2 mr-4 text-gray-600 bg-white rounded-full shadow-md hover:bg-gray-100 transition-colors","aria-label":"Volver al dashboard",children:e.jsx(J,{className:"w-6 h-6"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-800",children:"Mi Cuenta Corriente"}),e.jsx("p",{className:"text-gray-600",children:"Resumen de saldos y últimos movimientos."})]})]}),n?.is_admin&&e.jsxs("button",{onClick:()=>h(!0),className:"inline-flex items-center px-4 py-2 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 transition-colors",children:[e.jsx(R,{className:"w-5 h-5 mr-2"}),"Crear Nota de Crédito"]})]}),c&&e.jsxs("div",{className:"mb-6 flex items-center p-4 bg-green-100 text-green-700 rounded-lg shadow-md",children:[e.jsx($,{className:"w-5 h-5 mr-3 flex-shrink-0"}),e.jsx("span",{className:"text-sm font-medium",children:c})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4 md:gap-6 mb-8",children:[e.jsx(L,{title:"Saldo Total",amount:p.total,bgColorClass:p.total>=0?"text-green-600":"text-red-600"}),e.jsx(L,{title:"Disponible",amount:p.disponible,bgColorClass:"text-green-600"}),e.jsx(L,{title:"Pendiente de Imputación",amount:p.pendiente,bgColorClass:"text-yellow-600"})]}),e.jsxs("section",{children:[e.jsx("h2",{className:"text-2xl font-semibold text-gray-700 mb-4",children:"Detalle de Movimientos"}),e.jsx("div",{className:"md:hidden space-y-4",children:j?e.jsx("div",{className:"flex justify-center py-8",children:e.jsx(B,{text:"Cargando movimientos..."})}):m?e.jsxs("div",{className:"p-4 bg-red-100 text-red-700 rounded-lg",children:["Error: ",u.message]}):g.length>0?g.map(s=>e.jsxs("div",{className:"bg-white p-4 rounded-lg shadow-sm border border-gray-100",children:[e.jsxs("div",{className:"flex justify-between items-start mb-2",children:[e.jsxs("div",{children:[e.jsx("span",{className:"block font-bold text-gray-800 text-sm",children:s.titulo_num||"S/N"}),e.jsxs("span",{className:"text-xs text-gray-500",children:["Emisión: ",s.formatted_date]})]}),e.jsxs("span",{className:"text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded",children:["Vence: ",s.formatted_fecha_vencimiento||"-"]})]}),e.jsxs("div",{className:"flex justify-between items-center mt-3 pt-3 border-t border-gray-50",children:[e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-xs text-gray-500 uppercase",children:"Importe"}),s.debit>0?e.jsxs("span",{className:"font-bold text-red-600",children:["- ",x(s.debit)]}):e.jsxs("span",{className:"font-bold text-green-600",children:["+ ",x(s.credit)]})]}),e.jsxs("div",{className:"flex flex-col items-end",children:[e.jsx("span",{className:"text-xs text-gray-500 uppercase",children:"Saldo"}),e.jsx("span",{className:"font-bold text-gray-800",children:x(s.balance)})]})]})]},s.id)):e.jsx("div",{className:"p-8 text-center bg-white rounded-lg text-gray-500",children:"No se registraron movimientos."})}),e.jsx("div",{className:"hidden md:block bg-white rounded-lg shadow-md overflow-hidden",children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full bg-white",children:[e.jsx("thead",{className:"bg-gray-100 border-b border-gray-300",children:e.jsxs("tr",{children:[e.jsx("th",{className:"py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider",children:"Num. Titulo"}),e.jsx("th",{className:"py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider",children:"Fch Emision"}),e.jsx("th",{className:"py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider",children:"Fch. de Vencimien."}),e.jsx("th",{className:"py-3 px-4 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider",children:"Debitos"}),e.jsx("th",{className:"py-3 px-4 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider",children:"Creditos"}),e.jsx("th",{className:"py-3 px-4 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider",children:"Saldo Acumulados"}),e.jsx("th",{className:"py-3 px-4 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider",children:"% Canc."}),e.jsx("th",{className:"py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider",children:"N° Recibo"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-200",children:j?e.jsx("tr",{children:e.jsx("td",{colSpan:"8",className:"py-6 px-4 text-center text-gray-500",children:e.jsx("div",{className:"flex justify-center items-center p-0",children:e.jsx(B,{text:"Cargando movimientos..."})})})}):m?e.jsx("tr",{children:e.jsxs("td",{colSpan:"8",className:"py-6 px-4 text-center text-red-500",children:["Error al cargar los movimientos:"," ",u.message]})}):g.length>0?g.map(s=>e.jsxs("tr",{className:"hover:bg-gray-50",children:[e.jsx("td",{className:"py-3 px-4 text-sm text-gray-700",children:s.titulo_num||"-"}),e.jsx("td",{className:"py-3 px-4 text-sm text-gray-700",children:s.formatted_date}),e.jsx("td",{className:"py-3 px-4 text-sm text-gray-700",children:s.formatted_fecha_vencimiento||"-"}),e.jsx("td",{className:"py-3 px-4 text-sm font-semibold text-right text-red-600",children:s.debit?x(s.debit):"-"}),e.jsx("td",{className:"py-3 px-4 text-sm font-semibold text-right text-green-600",children:s.credit?x(s.credit):"-"}),e.jsx("td",{className:"py-3 px-4 text-sm font-bold text-right text-gray-800",children:x(s.balance)}),e.jsx("td",{className:"py-3 px-4 text-sm text-right text-gray-700",children:s.porc_cancelado?`${s.porc_cancelado}%`:"-"}),e.jsx("td",{className:"py-3 px-4 text-sm text-gray-600",children:s.order_ref||"-"})]},s.id)):e.jsx("tr",{children:e.jsx("td",{colSpan:"8",className:"py-6 px-4 text-center text-gray-500",children:"No se registraron movimientos."})})})]})})})]})]})]})}export{xe as default};
