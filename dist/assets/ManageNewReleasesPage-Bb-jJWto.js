import{r as h,i as G,u as V,b as X,e as B,j as e,h as W,d as H,a as f,z as b}from"./index-BSitqhbl.js";import{u as R}from"./useMutation-DRCD42ES.js";import{u as J}from"./useInfiniteQuery-CC8bdMhm.js";import{A as Y}from"./arrow-left-B7VcC6yx.js";import{F as Z,C as ee,P as se}from"./pen-CB5EHC_r.js";import{S as te}from"./star-CwjOWTFp.js";import{X as k}from"./x-DArI3Zcm.js";import{U as re}from"./upload-C5OqPCHi.js";import{L as ae}from"./loader-circle-CkpbbcTU.js";import{S as ne}from"./save-CwBKHmxr.js";const D=({checked:t,onChange:u,disabled:n,labelOff:x,labelOn:a,colorClass:d="bg-purple-600"})=>e.jsx("button",{type:"button",onClick:u,disabled:n,className:`relative inline-flex items-center h-6 rounded-full w-11 transition-colors duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 ${t?d:"bg-gray-300"} ${n?"opacity-50 cursor-not-allowed":"cursor-pointer"}`,"aria-label":t?a||"Desactivar":x||"Activar",children:e.jsx("span",{className:`inline-block w-4 h-4 transform bg-white rounded-full transition-transform duration-200 ease-in-out ${t?"translate-x-6":"translate-x-1"}`})}),ie=({product:t,onClose:u,onSave:n,isSaving:x})=>{const[a,d]=h.useState({custom_title:t.custom_title||"",custom_description:t.custom_description||"",custom_image_url:t.custom_image_url||""}),i=o=>{const{name:l,value:y}=o.target;d(m=>({...m,[l]:y}))},N=o=>{o.preventDefault(),n(t.id,a)};return e.jsx("div",{className:"fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-xl w-full max-w-md overflow-hidden max-h-[90vh] flex flex-col",children:[e.jsxs("div",{className:"px-6 py-4 border-b border-gray-200 flex justify-between items-center bg-gray-50",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-800",children:"Editar Lanzamiento"}),e.jsx("button",{onClick:u,className:"text-gray-400 hover:text-gray-600 cursor-pointer",children:e.jsx(k,{className:"w-5 h-5"})})]}),e.jsx("div",{className:"overflow-y-auto p-6",children:e.jsxs("form",{onSubmit:N,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Título Personalizado"}),e.jsx("input",{type:"text",name:"custom_title",value:a.custom_title,onChange:i,placeholder:t.name,className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Dejar en blanco para usar el nombre original."})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Descripción Personalizada"}),e.jsx("textarea",{name:"custom_description",value:a.custom_description,onChange:i,rows:"3",className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Imagen Personalizada"}),(a.custom_image_url||a.previewUrl)&&e.jsxs("div",{className:"mb-2 relative w-full h-48 bg-gray-100 rounded-md overflow-hidden border border-gray-200",children:[e.jsx("img",{src:a.previewUrl||a.custom_image_url,alt:"Preview",className:"w-full h-full object-contain",referrerPolicy:"no-referrer"}),e.jsx("button",{type:"button",onClick:()=>d(o=>({...o,custom_image_url:"",previewUrl:""})),className:"absolute top-1 right-1 bg-red-500 text-white rounded-full p-1 hover:bg-red-600 shadow-sm",title:"Eliminar imagen",children:e.jsx(k,{className:"w-4 h-4"})})]}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsxs("label",{className:"flex-1 cursor-pointer bg-white border border-gray-300 rounded-md px-3 py-2 text-sm text-gray-700 hover:bg-gray-50 flex items-center justify-center gap-2",children:[e.jsx(re,{className:"w-4 h-4"}),a.isUploading?"Subiendo...":"Seleccionar Imagen",e.jsx("input",{type:"file",accept:"image/*",className:"hidden",disabled:a.isUploading,onChange:async o=>{const l=o.target.files[0];if(!l)return;const y=URL.createObjectURL(l);d(p=>({...p,isUploading:!0,previewUrl:y}));const m=new FormData;m.append("image",l);try{const p=await f.uploadToDrive(m);d(j=>({...j,custom_image_url:p.imageUrl,isUploading:!1})),b.success("Imagen subida a Drive correctamente")}catch(p){console.error(p),b.error("Error al subir imagen"),d(j=>({...j,isUploading:!1}))}}})]})})]}),e.jsxs("div",{className:"pt-4 flex justify-end space-x-3",children:[e.jsx("button",{type:"button",onClick:u,className:"px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 cursor-pointer",children:"Cancelar"}),e.jsx("button",{type:"submit",disabled:x||a.isUploading,className:"px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700 flex items-center disabled:opacity-50 cursor-pointer",children:x?e.jsxs(e.Fragment,{children:[e.jsx(ae,{className:"w-4 h-4 mr-2 animate-spin"}),"Guardando..."]}):e.jsxs(e.Fragment,{children:[e.jsx(ne,{className:"w-4 h-4 mr-2"}),"Guardar Cambios"]})})]})]})})]})})},oe=({product:t,onToggle:u,isToggling:n,onEdit:x})=>e.jsxs("tr",{className:"border-b border-gray-200 hover:bg-gray-50",children:[e.jsx("td",{className:"py-3 px-4 text-sm text-gray-500 font-mono",children:t.code}),e.jsx("td",{className:"py-3 px-4 text-sm text-gray-900 font-medium",children:e.jsxs("div",{children:[t.custom_title||t.name,t.custom_title&&e.jsx("span",{className:"ml-2 text-xs text-purple-600 bg-purple-50 px-2 py-0.5 rounded-full border border-purple-100",children:"Personalizado"})]})}),e.jsx("td",{className:"py-3 px-4 text-sm text-gray-500",children:t.is_new_release?e.jsxs("span",{className:"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800",children:[e.jsx(te,{className:"w-4 h-4 mr-1 fill-current"}),"Lanzamiento"]}):e.jsxs("span",{className:"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800",children:[e.jsx(ee,{className:"w-4 h-4 mr-1"}),"Estándar"]})}),e.jsx("td",{className:"py-3 px-4 text-center",children:e.jsxs("div",{className:"flex items-center justify-center space-x-4",children:[e.jsx(D,{checked:!!t.is_new_release,onChange:u,disabled:n}),t.is_new_release&&e.jsx("button",{onClick:()=>x(t),className:"p-1 text-gray-400 hover:text-blue-600 transition-colors cursor-pointer",title:"Editar detalles de lanzamiento",children:e.jsx(se,{className:"w-5 h-5"})})]})})]});function be(){const[t,u]=h.useState(""),[n,x]=h.useState(""),[a,d]=h.useState(null),[i,N]=h.useState(!1),o=h.useRef(null),l=G(),y=V(),{user:m}=X();h.useEffect(()=>(o.current&&clearTimeout(o.current),o.current=setTimeout(()=>{x(t)},500),()=>clearTimeout(o.current)),[t]);const{data:p,fetchNextPage:j,hasNextPage:P,isFetchingNextPage:E,isLoading:z,isError:U,error:T}=J({queryKey:["products",n,["new_releases"]],queryFn:async({pageParam:s=1})=>{const r=await f.fetchProducts(s,n,[],!0),g=await f.fetchNewReleases(),c=new Map(g.map(w=>[w.code,w])),S=r.products.map(w=>{const v=c.get(w.code);return{...w,is_new_release:!!v,custom_title:v?.custom_title,custom_description:v?.custom_description,custom_image_url:v?.custom_image_url}});return{...r,products:S}},getNextPageParam:(s,r)=>r.reduce((c,S)=>c+S.products.length,0)<s.totalProducts?r.length+1:void 0,initialPageParam:1,enabled:!!(m?.is_admin||m?.role==="marketing")&&!i}),{data:F,isLoading:A,isError:q,error:I}=B({queryKey:["activeNewReleases",n],queryFn:async()=>{const r=(await f.fetchNewReleases()).map(c=>({...c,is_new_release:!0}));if(!n)return r;const g=n.toLowerCase();return r.filter(c=>c.name.toLowerCase().includes(g)||c.code.toLowerCase().includes(g))},enabled:!!(m?.is_admin||m?.role==="marketing")&&i}),{mutate:Q,isPending:K}=R({mutationFn:s=>f.toggleProductNewRelease(s),onSuccess:s=>{l.setQueryData(["products",n,["new_releases"]],r=>r&&{...r,pages:r.pages.map(g=>({...g,products:g.products.map(c=>c.id===s.id?{...c,is_new_release:s.is_new_release}:c)}))}),l.invalidateQueries({queryKey:["activeNewReleases"]}),l.invalidateQueries({queryKey:["newReleases"]}),b.success(s.is_new_release?"Lanzamiento activado correctamente":"Lanzamiento desactivado correctamente")},onError:s=>{b.error(`Error: ${s.message}`)}}),{mutate:M,isPending:$}=R({mutationFn:({productId:s,details:r})=>f.updateProductNewReleaseDetails(s,r),onSuccess:(s,r)=>{l.invalidateQueries({queryKey:["products",n,["new_releases"]]}),l.invalidateQueries({queryKey:["activeNewReleases"]}),l.invalidateQueries({queryKey:["newReleases"]}),d(null),b.success("Detalles actualizados")},onError:s=>{b.error(`Error: ${s.message}`)}}),_=i?F||[]:p?.pages.flatMap(s=>s.products)||[],C=i?A:z,L=i?q:U,O=i?I:T;return!m?.is_admin&&m?.role!=="marketing"?e.jsx("div",{className:"p-8 text-center text-red-500",children:"Acceso denegado."}):e.jsxs("div",{className:"p-6 bg-gray-50 min-h-screen",children:[e.jsx("header",{className:"mb-6 flex items-center justify-between",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("button",{onClick:()=>y("/manage-content"),className:"flex items-center justify-center p-2 mr-4 text-gray-600 bg-white rounded-full shadow-md hover:bg-gray-100 transition-colors cursor-pointer","aria-label":"Volver a Configuración",children:e.jsx(Y,{className:"w-6 h-6"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-800",children:"Gestionar Nuevos Lanzamientos"}),e.jsx("p",{className:"text-gray-500",children:"Destaca productos como nuevos lanzamientos en la plataforma."})]})]})}),e.jsxs("div",{className:"mb-6 flex flex-col md:flex-row md:items-center justify-between gap-4",children:[e.jsxs("div",{className:"relative flex-1 max-w-sm",children:[e.jsx(W,{className:"w-5 h-5 text-gray-400 absolute left-3 top-1/2 -translate-y-1/2"}),e.jsx("input",{type:"text",value:t,onChange:s=>u(s.target.value),placeholder:"Buscar por nombre o código...",className:"w-full pl-10 pr-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),e.jsxs("div",{className:"flex items-center space-x-3 bg-white p-2 rounded-lg shadow-sm border border-gray-200",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(Z,{className:`w-5 h-5 ${i?"text-purple-600":"text-gray-400"}`}),e.jsx("span",{className:"text-sm font-medium text-gray-700",children:"Ver solo activos"})]}),e.jsx(D,{checked:i,onChange:()=>N(!i),labelOff:"Mostrar todo",labelOn:"Solo activos",colorClass:"bg-purple-600"})]})]}),e.jsxs("div",{className:"bg-white rounded-lg shadow-md overflow-hidden",children:[e.jsx("div",{className:"hidden md:block overflow-x-auto",children:e.jsxs("table",{className:"min-w-full bg-white",children:[e.jsx("thead",{className:"bg-gray-100 border-b border-gray-300",children:e.jsxs("tr",{children:[e.jsx("th",{className:"py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase",children:"Código"}),e.jsx("th",{className:"py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase",children:"Descripción"}),e.jsx("th",{className:"py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase",children:"Estado"}),e.jsx("th",{className:"py-3 px-4 text-center text-xs font-semibold text-gray-600 uppercase",children:"Acciones"})]})}),e.jsxs("tbody",{className:"divide-y divide-gray-200",children:[C&&e.jsx("tr",{children:e.jsx("td",{colSpan:"4",className:"p-0",children:e.jsx(H,{text:"Cargando productos..."})})}),L&&e.jsx("tr",{children:e.jsxs("td",{colSpan:"4",className:"p-8 text-center text-red-500",children:["Error: ",O?.message]})}),!C&&!L&&_.length===0&&e.jsx("tr",{children:e.jsxs("td",{colSpan:"4",className:"p-8 text-center text-gray-500",children:["No se encontraron productos",i?" activos.":"."]})}),_.map(s=>e.jsx(oe,{product:s,onToggle:()=>Q(s.id),isToggling:K,onEdit:d},s.id))]})]})}),!i&&e.jsxs("div",{className:"p-4 text-center",children:[P&&e.jsx("button",{onClick:()=>j(),disabled:E,className:"mt-4 px-6 py-2 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 disabled:opacity-50 cursor-pointer",children:E?"Cargando...":"Cargar más productos"}),!P&&!C&&_.length>0&&e.jsx("p",{className:"text-gray-500 text-sm",children:"Fin de los resultados."})]})]}),a&&e.jsx(ie,{product:a,onClose:()=>d(null),onSave:(s,r)=>M({productId:s,details:r}),isSaving:$})]})}export{be as default};
