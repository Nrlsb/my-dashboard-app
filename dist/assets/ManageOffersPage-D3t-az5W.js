import{f as Z,u as H,b as J,c as W,j as e,L,a as C}from"./index-BWABKLod.js";import{r as f,A as ee,S as se,Y as te,u as T,Z as F,_ as z,$ as I,z as p,X as S,a0 as re,x as ae,a1 as le,e as ie}from"./ui-libs-DsBefQ5G.js";import{u as U}from"./useMutation-C3urU2a5.js";import{u as ne}from"./useInfiniteQuery-DWkNJ2N8.js";import"./vendor-qkC6yhPU.js";const k=({checked:s,onChange:c,disabled:i,labelOff:n,labelOn:a,colorClass:o="bg-green-600"})=>e.jsx("button",{type:"button",onClick:c,disabled:i,className:`relative inline-flex items-center h-6 rounded-full w-11 transition-colors duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 ${s?o:"bg-gray-300"} ${i?"opacity-50 cursor-not-allowed":"cursor-pointer"}`,"aria-label":s?a||"Desactivar":n||"Activar",children:e.jsx("span",{className:`inline-block w-4 h-4 transform bg-white rounded-full transition-transform duration-200 ease-in-out ${s?"translate-x-6":"translate-x-1"}`})}),oe=({product:s,onClose:c,onSave:i,isSaving:n})=>{const[a,o]=f.useState({custom_title:s.custom_title||"",custom_description:s.custom_description||"",custom_image_url:s.custom_image_url||""}),y=r=>{const{name:h,value:u}=r.target;o(d=>({...d,[h]:u}))},j=r=>{r.preventDefault(),i(s.id,a)};return e.jsx("div",{className:"fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-xl w-full max-w-md overflow-hidden max-h-[90vh] flex flex-col",children:[e.jsxs("div",{className:"px-6 py-4 border-b border-gray-200 flex justify-between items-center bg-gray-50",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-800",children:"Editar Oferta"}),e.jsx("button",{onClick:c,className:"text-gray-400 hover:text-gray-600 cursor-pointer",children:e.jsx(S,{className:"w-5 h-5"})})]}),e.jsx("div",{className:"overflow-y-auto p-6",children:e.jsxs("form",{onSubmit:j,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Título Personalizado"}),e.jsx("input",{type:"text",name:"custom_title",value:a.custom_title,onChange:y,placeholder:s.name,className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Dejar en blanco para usar el nombre original."})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Descripción Personalizada"}),e.jsx("textarea",{name:"custom_description",value:a.custom_description,onChange:y,rows:"3",className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Imagen Personalizada"}),(a.custom_image_url||a.previewUrl)&&e.jsxs("div",{className:"mb-2 relative w-full h-48 bg-gray-100 rounded-md overflow-hidden border border-gray-200",children:[e.jsx("img",{src:a.previewUrl||a.custom_image_url,alt:"Preview",className:"w-full h-full object-contain",referrerPolicy:"no-referrer"}),e.jsx("button",{type:"button",onClick:()=>o(r=>({...r,custom_image_url:"",previewUrl:""})),className:"absolute top-1 right-1 bg-red-500 text-white rounded-full p-1 hover:bg-red-600 shadow-sm",title:"Eliminar imagen",children:e.jsx(S,{className:"w-4 h-4"})})]}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsxs("label",{className:"flex-1 cursor-pointer bg-white border border-gray-300 rounded-md px-3 py-2 text-sm text-gray-700 hover:bg-gray-50 flex items-center justify-center gap-2",children:[e.jsx(re,{className:"w-4 h-4"}),a.isUploading?"Subiendo...":"Seleccionar Imagen",e.jsx("input",{type:"file",accept:"image/*",className:"hidden",disabled:a.isUploading,onChange:async r=>{const h=r.target.files[0];if(!h)return;const u=URL.createObjectURL(h);o(b=>({...b,isUploading:!0,previewUrl:u}));const d=new FormData;d.append("image",h);try{const b=await C.uploadToDrive(d);o(x=>({...x,custom_image_url:b.imageUrl,isUploading:!1})),p.success("Imagen subida a Drive correctamente")}catch(b){console.error(b),p.error("Error al subir imagen"),o(x=>({...x,isUploading:!1}))}}})]})}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Sube una imagen para guardarla en Google Drive."})]}),e.jsxs("div",{className:"pt-4 flex justify-end space-x-3",children:[e.jsx("button",{type:"button",onClick:c,className:"px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 cursor-pointer",children:"Cancelar"}),e.jsx("button",{type:"submit",disabled:n||a.isUploading,className:"px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700 flex items-center disabled:opacity-50 cursor-pointer",children:n?e.jsxs(e.Fragment,{children:[e.jsx(ae,{className:"w-4 h-4 mr-2 animate-spin"}),"Guardando..."]}):e.jsxs(e.Fragment,{children:[e.jsx(le,{className:"w-4 h-4 mr-2"}),"Guardar Cambios"]})})]})]})})]})})},ce=({product:s,onClose:c})=>{const i=n=>new Intl.NumberFormat("es-AR",{style:"currency",currency:"ARS",minimumFractionDigits:2,maximumFractionDigits:2}).format(n||0);return e.jsx("div",{className:"fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4",onClick:c,children:e.jsxs("div",{className:"bg-white rounded-lg shadow-xl w-full max-w-sm overflow-hidden flex flex-col",onClick:n=>n.stopPropagation(),children:[e.jsxs("div",{className:"px-6 py-4 border-b border-gray-200 flex justify-between items-center bg-gray-50",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-800",children:"Vista Previa de Oferta"}),e.jsx("button",{onClick:c,className:"text-gray-400 hover:text-gray-600 cursor-pointer",children:e.jsx(S,{className:"w-5 h-5"})})]}),e.jsx("div",{className:"p-8 bg-gray-100 flex justify-center",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-lg overflow-hidden flex flex-col justify-between w-full border border-gray-100 max-w-[280px]",children:[(s.custom_image_url||s.imageUrl)&&e.jsxs("div",{className:"h-40 w-full overflow-hidden relative",children:[e.jsx("img",{src:s.custom_image_url||s.imageUrl,alt:s.custom_title||s.name,className:"w-full h-full object-cover"}),e.jsx("span",{className:"absolute bottom-0 right-0 bg-black/50 text-white text-[9px] px-2 py-0.5 pointer-events-none uppercase tracking-wider font-bold rounded-tl-md backdrop-blur-sm",children:"Imagen ilustrativa"})]}),e.jsxs("div",{className:"p-5 flex-grow flex flex-col",children:[e.jsxs("div",{className:"flex items-start justify-between mb-2",children:[e.jsx("span",{className:"inline-block bg-blue-100 text-blue-800 text-[10px] font-semibold px-2 py-0.5 rounded-full uppercase",children:s.brand||"Marca"}),e.jsx(ie,{className:"w-5 h-5 text-blue-500"})]}),e.jsx("h3",{className:`text-sm font-semibold text-gray-800 mb-2 ${s.custom_description?"":"h-10 overflow-hidden"}`,title:s.custom_title||s.name,children:s.custom_title||s.name}),(s.custom_description||s.description)&&e.jsx("p",{className:"text-xs text-gray-600 mb-3 line-clamp-2",children:s.custom_description||s.description}),e.jsxs("p",{className:"text-[10px] text-gray-500 mb-3 font-mono",children:["Cód: ",s.code]}),e.jsx("div",{className:"mt-auto",children:e.jsx("p",{className:"text-xl font-bold text-gray-900",children:i(s.price)})})]}),e.jsx("div",{className:"p-3 bg-gray-50 mt-auto",children:e.jsx("button",{className:"w-full bg-blue-500 text-white py-2 px-4 rounded-lg text-sm font-medium opacity-80 cursor-default",disabled:!0,children:"Ver Detalle"})})]})}),e.jsx("div",{className:"px-6 py-3 bg-gray-50 border-t border-gray-200 text-center",children:e.jsx("p",{className:"text-xs text-gray-500 italic",children:"Así es como se visualiza en la sección de ofertas."})})]})})},de=({product:s,onToggle:c,isToggling:i,onEdit:n,onPreview:a})=>e.jsxs("tr",{className:"border-b border-gray-200 hover:bg-gray-50",children:[e.jsx("td",{className:"py-3 px-4 text-sm text-gray-500 font-mono",children:s.code}),e.jsx("td",{className:"py-3 px-4 text-sm text-gray-900 font-medium",children:e.jsxs("div",{children:[s.custom_title||s.name,s.custom_title&&e.jsx("span",{className:"ml-2 text-xs text-blue-600 bg-blue-50 px-2 py-0.5 rounded-full border border-blue-100",children:"Personalizado"})]})}),e.jsx("td",{className:"py-3 px-4 text-sm text-gray-500",children:s.oferta?e.jsxs("span",{className:"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800",children:[e.jsx(T,{className:"w-4 h-4 mr-1"}),"En Oferta"]}):e.jsxs("span",{className:"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800",children:[e.jsx(F,{className:"w-4 h-4 mr-1"}),"Sin Oferta"]})}),e.jsx("td",{className:"py-3 px-4 text-center",children:e.jsxs("div",{className:"flex items-center justify-center space-x-4",children:[e.jsx(k,{checked:s.oferta,onChange:c,disabled:i,labelOff:"Activar oferta",labelOn:"Desactivar oferta"}),e.jsxs("div",{className:"flex items-center space-x-2 border-l pl-4 border-gray-100",children:[e.jsx("button",{onClick:()=>a(s),className:"p-1 text-gray-400 hover:text-blue-600 transition-colors cursor-pointer",title:"Vista previa de oferta",children:e.jsx(z,{className:"w-5 h-5"})}),e.jsx("button",{onClick:()=>n(s),className:"p-1 text-gray-400 hover:text-blue-600 transition-colors cursor-pointer",title:"Editar detalles de oferta",children:e.jsx(I,{className:"w-5 h-5"})})]})]})})]});function he(){const[s,c]=f.useState(""),[i,n]=f.useState(""),[a,o]=f.useState(null),[y,j]=f.useState(null),[r,h]=f.useState(!1),u=f.useRef(null),d=Z(),b=H(),{user:x}=J();f.useEffect(()=>(u.current&&clearTimeout(u.current),u.current=setTimeout(()=>{n(s)},500),()=>clearTimeout(u.current)),[s]);const{data:q,fetchNextPage:Q,hasNextPage:P,isFetchingNextPage:O,isLoading:$,isError:M,error:R}=ne({queryKey:["products",i,[]],queryFn:({pageParam:t=1})=>C.fetchProducts(t,i,[],!0),getNextPageParam:(t,l)=>l.reduce((g,w)=>g+w.products.length,0)<t.totalProducts?l.length+1:void 0,initialPageParam:1,enabled:!!(x?.is_admin||x?.role==="marketing")&&!r}),{data:K,isLoading:V,isError:G,error:B}=W({queryKey:["activeOffers",i],queryFn:async()=>{const t=await C.fetchOffers();if(!i)return t;const l=i.toLowerCase();return t.filter(m=>m.name.toLowerCase().includes(l)||m.code.toLowerCase().includes(l))},enabled:!!(x?.is_admin||x?.role==="marketing")&&r}),{mutate:E,isPending:D}=U({mutationFn:t=>C.toggleProductOffer(t),onSuccess:t=>{d.setQueryData(["products",i,[]],l=>l&&{...l,pages:l.pages.map(m=>({...m,products:m.products.map(g=>g.id===t.id?{...g,oferta:t.oferta}:g)}))}),d.invalidateQueries({queryKey:["activeOffers"]}),d.invalidateQueries({queryKey:["offers"]}),p.success(t.oferta?"Oferta activada correctamente":"Oferta desactivada correctamente")},onError:t=>{p.error(`Error al cambiar el estado de la oferta: ${t.message}`)}}),{mutate:X,isPending:Y}=U({mutationFn:({productId:t,details:l})=>C.updateProductOfferDetails(t,l),onSuccess:(t,l)=>{d.setQueryData(["products",i,[]],m=>m&&{...m,pages:m.pages.map(g=>({...g,products:g.products.map(w=>w.id===l.productId?{...w,...l.details}:w)}))}),d.invalidateQueries({queryKey:["activeOffers"]}),d.invalidateQueries({queryKey:["offers"]}),o(null),p.success("Detalles de la oferta actualizados")},onError:t=>{p.error(`Error al guardar los detalles: ${t.message}`)}}),v=r?K||[]:q?.pages.flatMap(t=>t.products)||[],N=r?V:$,_=r?G:M,A=r?B:R;return!x?.is_admin&&x?.role!=="marketing"?e.jsx("div",{className:"p-8 text-center text-red-500",children:"Acceso denegado."}):e.jsxs("div",{className:"p-6 bg-gray-50 min-h-screen",children:[e.jsx("header",{className:"mb-6 flex items-center justify-between",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("button",{onClick:()=>b("/manage-content"),className:"flex items-center justify-center p-2 mr-4 text-gray-600 bg-white rounded-full shadow-md hover:bg-gray-100 transition-colors cursor-pointer","aria-label":"Volver a Configuración",children:e.jsx(ee,{className:"w-6 h-6"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-800",children:"Gestionar Ofertas"}),e.jsx("p",{className:"text-gray-500",children:"Activa o desactiva productos en oferta y personaliza su apariencia."})]})]})}),e.jsxs("div",{className:"mb-6 flex flex-col md:flex-row md:items-center justify-between gap-4",children:[e.jsxs("div",{className:"relative flex-1 max-w-sm",children:[e.jsx(se,{className:"w-5 h-5 text-gray-400 absolute left-3 top-1/2 -translate-y-1/2"}),e.jsx("input",{type:"text",value:s,onChange:t=>c(t.target.value),placeholder:"Buscar por nombre o código...",className:"w-full pl-10 pr-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),e.jsxs("div",{className:"flex items-center space-x-3 bg-white p-2 rounded-lg shadow-sm border border-gray-200",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(te,{className:`w-5 h-5 ${r?"text-blue-600":"text-gray-400"}`}),e.jsx("span",{className:"text-sm font-medium text-gray-700",children:"Ver solo activas"})]}),e.jsx(k,{checked:r,onChange:()=>h(!r),labelOff:"Mostrar todo",labelOn:"Solo activos",colorClass:"bg-blue-600"})]})]}),e.jsxs("div",{className:"bg-white rounded-lg shadow-md overflow-hidden",children:[e.jsxs("div",{className:"md:hidden divide-y divide-gray-200",children:[N&&e.jsx("div",{className:"p-4",children:e.jsx(L,{text:"Cargando productos..."})}),_&&e.jsxs("div",{className:"p-8 text-center text-red-500",children:["Error: ",A?.message]}),!N&&!_&&v.length===0&&e.jsxs("div",{className:"p-8 text-center text-gray-500",children:["No se encontraron productos",r?" activos.":"."]}),v.map(t=>e.jsxs("div",{className:"p-4 flex flex-col space-y-3",children:[e.jsx("div",{className:"flex justify-between items-start",children:e.jsxs("div",{className:"pr-4",children:[e.jsx("h3",{className:"text-sm font-bold text-gray-900 line-clamp-2",children:t.custom_title||t.name}),e.jsxs("p",{className:"text-xs text-gray-500 font-mono mt-1",children:["Cód: ",t.code]}),t.custom_title&&e.jsx("span",{className:"inline-block mt-1 text-[10px] text-blue-600 bg-blue-50 px-1.5 py-0.5 rounded border border-blue-100",children:"Personalizado"})]})}),e.jsxs("div",{className:"flex items-center justify-between pt-2 border-t border-gray-50",children:[e.jsx("div",{children:t.oferta?e.jsxs("span",{className:"inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800",children:[e.jsx(T,{className:"w-3 h-3 mr-1"}),"En Oferta"]}):e.jsxs("span",{className:"inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800",children:[e.jsx(F,{className:"w-3 h-3 mr-1"}),"Sin Oferta"]})}),e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("button",{onClick:()=>j(t),className:"p-2 text-gray-400 hover:text-blue-600 bg-gray-50 rounded-full transition-colors cursor-pointer","aria-label":"Vista previa",children:e.jsx(z,{className:"w-5 h-5"})}),e.jsx("button",{onClick:()=>o(t),className:"p-2 text-gray-400 hover:text-blue-600 bg-gray-50 rounded-full transition-colors cursor-pointer","aria-label":"Editar oferta",children:e.jsx(I,{className:"w-5 h-5"})}),e.jsx(k,{checked:t.oferta,onChange:()=>E(t.id),disabled:D})]})]})]},t.id))]}),e.jsx("div",{className:"hidden md:block overflow-x-auto",children:e.jsxs("table",{className:"min-w-full bg-white",children:[e.jsx("thead",{className:"bg-gray-100 border-b border-gray-300",children:e.jsxs("tr",{children:[e.jsx("th",{className:"py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase",children:"Código"}),e.jsx("th",{className:"py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase",children:"Descripción"}),e.jsx("th",{className:"py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase",children:"Estado Actual"}),e.jsx("th",{className:"py-3 px-4 text-center text-xs font-semibold text-gray-600 uppercase",children:"Acciones"})]})}),e.jsxs("tbody",{className:"divide-y divide-gray-200",children:[N&&e.jsx("tr",{children:e.jsx("td",{colSpan:"4",className:"p-0",children:e.jsx(L,{text:"Cargando productos..."})})}),_&&e.jsx("tr",{children:e.jsxs("td",{colSpan:"4",className:"p-8 text-center text-red-500",children:["Error: ",A?.message]})}),!N&&!_&&v.length===0&&e.jsx("tr",{children:e.jsxs("td",{colSpan:"4",className:"p-8 text-center text-gray-500",children:["No se encontraron productos",r?" activos.":"."]})}),v.map(t=>e.jsx(de,{product:t,onToggle:()=>E(t.id),isToggling:D,onEdit:o,onPreview:j},t.id))]})]})}),!r&&e.jsxs("div",{className:"p-4 text-center",children:[P&&e.jsx("button",{onClick:()=>Q(),disabled:O,className:"mt-4 px-6 py-2 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 disabled:opacity-50 cursor-pointer",children:O?"Cargando...":"Cargar más productos"}),!P&&!N&&v.length>0&&e.jsx("p",{className:"text-gray-500 text-sm",children:"Fin de los resultados."})]})]}),a&&e.jsx(oe,{product:a,onClose:()=>o(null),onSave:(t,l)=>X({productId:t,details:l}),isSaving:Y}),y&&e.jsx(ce,{product:y,onClose:()=>j(null)})]})}export{he as default};
