import{j as e,a as j,A as M}from"./index-BpIgjRdq.js";import{r as o,ae as v,a6 as m}from"./ui-libs-DeieS4Kk.js";import{C as O}from"./ConfirmationModal-CKMTQaS7.js";import"./vendor-qkC6yhPU.js";const w=({progress:n,message:r})=>e.jsxs("div",{className:"w-full mt-4",children:[e.jsxs("div",{className:"flex justify-between text-xs mb-1",children:[e.jsx("span",{className:"font-medium text-gray-700",children:r}),e.jsxs("span",{className:"font-medium text-gray-700",children:[n,"%"]})]}),e.jsx("div",{className:"w-full bg-gray-200 rounded-full h-2.5",children:e.jsx("div",{className:"bg-blue-600 h-2.5 rounded-full transition-all duration-300 ease-out",style:{width:`${n}%`}})})]}),D=()=>{const[n,r]=o.useState(!1),[p,g]=o.useState(0),[f,x]=o.useState(""),[c,t]=o.useState(null),[N,S]=o.useState(!1),[i,h]=o.useState(null),y=l=>{n||(h(l),S(!0))},b=()=>{S(!1),h(null)},z=async()=>{const l=i;if(b(),!l)return;r(!0),t(l),g(0),x("Iniciando conexión...");const E=localStorage.getItem("authToken"),C=`${M}/admin/sync-events?token=${E}`,T=()=>new Promise((d,P)=>{const a=new EventSource(C);a.onopen=()=>{console.log("SSE Connection Opened"),d(a)},a.onmessage=u=>{try{const s=JSON.parse(u.data);s.type==="progress"&&(s.percent!==null&&g(s.percent),s.message&&x(s.message),s.status==="completed"?(m.success(s.message||"Sincronización completada"),a.close(),r(!1),t(null)):s.status==="error"&&(m.error(s.message||"Error en la sincronización"),a.close(),r(!1),t(null)))}catch(s){console.error("Error parsing SSE data",s)}},a.onerror=u=>{console.error("SSE Error",u),a.readyState===2&&(a.close(),r(!1),t(null),P(new Error("Connection failed")))}});try{const d=await T();l==="manual"?await j.triggerManualSync():await j.triggerFullSync()}catch(d){console.error(d),m.error("No se pudo establecer conexión para la sincronización."),r(!1),t(null)}};return e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6",children:[e.jsxs("div",{className:"bg-white p-6 rounded shadow border border-gray-200 flex flex-col items-center text-center relative overflow-hidden",children:[e.jsx("div",{className:"bg-green-100 p-4 rounded-full mb-4",children:e.jsx(v,{size:40,className:`text-green-600 ${n&&c==="manual"?"animate-spin":""}`})}),e.jsx("h3",{className:"font-bold text-lg mb-2",children:"Sincronización Manual"}),e.jsx("p",{className:"text-gray-600 text-sm mb-6",children:"Ejecuta manualmente el proceso de sincronización de productos y precios desde Protheus."}),n&&c==="manual"?e.jsx(w,{progress:p,message:f}):e.jsx("button",{onClick:()=>y("manual"),disabled:n,className:`bg-green-600 text-white px-4 py-2 rounded font-bold hover:bg-green-700 transition w-full ${n?"opacity-50 cursor-not-allowed":""}`,children:n?"Sincronizando...":"Sincronizar Ahora"})]}),e.jsxs("div",{className:"bg-white p-6 rounded shadow border border-gray-200 flex flex-col items-center text-center relative overflow-hidden",children:[e.jsx("div",{className:"bg-purple-100 p-4 rounded-full mb-4",children:e.jsx(v,{size:40,className:`text-purple-600 ${n&&c==="full"?"animate-spin":""}`})}),e.jsx("h3",{className:"font-bold text-lg mb-2",children:"Sincronización Total"}),e.jsx("p",{className:"text-gray-600 text-sm mb-6",children:"Sincroniza Productos, Precios, Clientes y Vendedores. Útil para actualizaciones masivas o iniciales."}),n&&c==="full"?e.jsx(w,{progress:p,message:f}):e.jsx("button",{onClick:()=>y("full"),disabled:n,className:`bg-purple-600 text-white px-4 py-2 rounded font-bold hover:bg-purple-700 transition w-full ${n?"opacity-50 cursor-not-allowed":""}`,children:n?"Sincronizando...":"Sincronizar Todo"})]}),e.jsx(O,{isOpen:N,onClose:b,onConfirm:z,title:i==="manual"?"Sincronización Manual":"Sincronización Total",message:i==="manual"?"¿Deseas iniciar la sincronización manual? Este proceso puede tomar varios minutos.":"¿Deseas iniciar la sincronización TOTAL? Este proceso abarca TODA la base de datos y puede demorar varios minutos.",confirmText:i==="manual"?"Sincronizar":"Sincronizar Todo",variant:i==="manual"?"info":"warning"})]})};export{D as default};
