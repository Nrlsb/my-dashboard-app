import{r as g,i as V,u as X,b as U,e as H,j as e,h as J,d as k,a as j,z as N}from"./index-D-idoHGn.js";import{u as L}from"./useMutation-CGdcMlkw.js";import{u as W}from"./useInfiniteQuery-CE5ZgkOu.js";import{A as Y}from"./arrow-left-LhT7PQl9.js";import{F as Z,C as A,P as T}from"./pen-VTlWNIRs.js";import{C as D}from"./circle-check-big-5zQm43Bs.js";import{X as ee}from"./x-TyXZf8Gc.js";import{L as se}from"./loader-circle-COkfAJxX.js";import{S as te}from"./save-Dkm82Tk9.js";const C=({checked:t,onChange:l,disabled:n,labelOff:c,labelOn:o,colorClass:d="bg-green-600"})=>e.jsx("button",{type:"button",onClick:l,disabled:n,className:`relative inline-flex items-center h-6 rounded-full w-11 transition-colors duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 ${t?d:"bg-gray-300"} ${n?"opacity-50 cursor-not-allowed":"cursor-pointer"}`,"aria-label":t?o||"Desactivar":c||"Activar",children:e.jsx("span",{className:`inline-block w-4 h-4 transform bg-white rounded-full transition-transform duration-200 ease-in-out ${t?"translate-x-6":"translate-x-1"}`})}),re=({product:t,onClose:l,onSave:n,isSaving:c})=>{const[o,d]=g.useState({custom_title:t.custom_title||"",custom_description:t.custom_description||"",custom_image_url:t.custom_image_url||""}),a=m=>{const{name:x,value:w}=m.target;d(u=>({...u,[x]:w}))},v=m=>{m.preventDefault(),n(t.id,o)};return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-xl w-full max-w-md overflow-hidden",children:[e.jsxs("div",{className:"px-6 py-4 border-b border-gray-200 flex justify-between items-center bg-gray-50",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-800",children:"Editar Oferta"}),e.jsx("button",{onClick:l,className:"text-gray-400 hover:text-gray-600 cursor-pointer",children:e.jsx(ee,{className:"w-5 h-5"})})]}),e.jsxs("form",{onSubmit:v,className:"p-6 space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Título Personalizado"}),e.jsx("input",{type:"text",name:"custom_title",value:o.custom_title,onChange:a,placeholder:t.name,className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Dejar en blanco para usar el nombre original."})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Descripción Personalizada"}),e.jsx("textarea",{name:"custom_description",value:o.custom_description,onChange:a,rows:"3",className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"URL de Imagen Personalizada"}),e.jsx("input",{type:"text",name:"custom_image_url",value:o.custom_image_url,onChange:a,placeholder:"https://ejemplo.com/imagen.jpg",className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),e.jsxs("div",{className:"pt-4 flex justify-end space-x-3",children:[e.jsx("button",{type:"button",onClick:l,className:"px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 cursor-pointer",children:"Cancelar"}),e.jsx("button",{type:"submit",disabled:c,className:"px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700 flex items-center disabled:opacity-50 cursor-pointer",children:c?e.jsxs(e.Fragment,{children:[e.jsx(se,{className:"w-4 h-4 mr-2 animate-spin"}),"Guardando..."]}):e.jsxs(e.Fragment,{children:[e.jsx(te,{className:"w-4 h-4 mr-2"}),"Guardar Cambios"]})})]})]})]})})},ae=({product:t,onToggle:l,isToggling:n,onEdit:c})=>e.jsxs("tr",{className:"border-b border-gray-200 hover:bg-gray-50",children:[e.jsx("td",{className:"py-3 px-4 text-sm text-gray-500 font-mono",children:t.code}),e.jsx("td",{className:"py-3 px-4 text-sm text-gray-900 font-medium",children:e.jsxs("div",{children:[t.custom_title||t.name,t.custom_title&&e.jsx("span",{className:"ml-2 text-xs text-blue-600 bg-blue-50 px-2 py-0.5 rounded-full border border-blue-100",children:"Personalizado"})]})}),e.jsx("td",{className:"py-3 px-4 text-sm text-gray-500",children:t.oferta?e.jsxs("span",{className:"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800",children:[e.jsx(D,{className:"w-4 h-4 mr-1"}),"En Oferta"]}):e.jsxs("span",{className:"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800",children:[e.jsx(A,{className:"w-4 h-4 mr-1"}),"Sin Oferta"]})}),e.jsx("td",{className:"py-3 px-4 text-center",children:e.jsxs("div",{className:"flex items-center justify-center space-x-4",children:[e.jsx(C,{checked:t.oferta,onChange:l,disabled:n,labelOff:"Activar oferta",labelOn:"Desactivar oferta"}),t.oferta&&e.jsx("button",{onClick:()=>c(t),className:"p-1 text-gray-400 hover:text-blue-600 transition-colors cursor-pointer",title:"Editar detalles de oferta",children:e.jsx(T,{className:"w-5 h-5"})})]})})]});function fe(){const[t,l]=g.useState(""),[n,c]=g.useState(""),[o,d]=g.useState(null),[a,v]=g.useState(!1),m=g.useRef(null),x=V(),w=X(),{user:u}=U();g.useEffect(()=>(m.current&&clearTimeout(m.current),m.current=setTimeout(()=>{c(t)},500),()=>clearTimeout(m.current)),[t]);const{data:F,fetchNextPage:z,hasNextPage:S,isFetchingNextPage:O,isLoading:q,isError:Q,error:I}=W({queryKey:["products",n,[]],queryFn:({pageParam:s=1})=>j.fetchProducts(s,n,[],!0),getNextPageParam:(s,r)=>r.reduce((f,b)=>f+b.products.length,0)<s.totalProducts?r.length+1:void 0,initialPageParam:1,enabled:!!(u?.is_admin||u?.role==="marketing")&&!a}),{data:K,isLoading:$,isError:M,error:R}=H({queryKey:["activeOffers",n],queryFn:async()=>{const s=await j.fetchOffers();if(!n)return s;const r=n.toLowerCase();return s.filter(i=>i.name.toLowerCase().includes(r)||i.code.toLowerCase().includes(r))},enabled:!!(u?.is_admin||u?.role==="marketing")&&a}),{mutate:E,isPending:P}=L({mutationFn:s=>j.toggleProductOffer(s),onSuccess:s=>{x.setQueryData(["products",n,[]],r=>r&&{...r,pages:r.pages.map(i=>({...i,products:i.products.map(f=>f.id===s.id?{...f,oferta:s.oferta}:f)}))}),x.invalidateQueries({queryKey:["activeOffers"]}),x.invalidateQueries({queryKey:["offers"]}),N.success(s.oferta?"Oferta activada correctamente":"Oferta desactivada correctamente")},onError:s=>{N.error(`Error al cambiar el estado de la oferta: ${s.message}`)}}),{mutate:G,isPending:B}=L({mutationFn:({productId:s,details:r})=>j.updateProductOfferDetails(s,r),onSuccess:(s,r)=>{x.setQueryData(["products",n,[]],i=>i&&{...i,pages:i.pages.map(f=>({...f,products:f.products.map(b=>b.id===r.productId?{...b,...r.details}:b)}))}),x.invalidateQueries({queryKey:["activeOffers"]}),x.invalidateQueries({queryKey:["offers"]}),d(null),N.success("Detalles de la oferta actualizados")},onError:s=>{N.error(`Error al guardar los detalles: ${s.message}`)}}),h=a?K||[]:F?.pages.flatMap(s=>s.products)||[],p=a?$:q,y=a?M:Q,_=a?R:I;return!u?.is_admin&&u?.role!=="marketing"?e.jsx("div",{className:"p-8 text-center text-red-500",children:"Acceso denegado."}):e.jsxs("div",{className:"p-6 bg-gray-50 min-h-screen",children:[e.jsx("header",{className:"mb-6 flex items-center justify-between",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("button",{onClick:()=>w("/manage-content"),className:"flex items-center justify-center p-2 mr-4 text-gray-600 bg-white rounded-full shadow-md hover:bg-gray-100 transition-colors cursor-pointer","aria-label":"Volver a Configuración",children:e.jsx(Y,{className:"w-6 h-6"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-800",children:"Gestionar Ofertas"}),e.jsx("p",{className:"text-gray-500",children:"Activa o desactiva productos en oferta y personaliza su apariencia."})]})]})}),e.jsxs("div",{className:"mb-6 flex flex-col md:flex-row md:items-center justify-between gap-4",children:[e.jsxs("div",{className:"relative flex-1 max-w-sm",children:[e.jsx(J,{className:"w-5 h-5 text-gray-400 absolute left-3 top-1/2 -translate-y-1/2"}),e.jsx("input",{type:"text",value:t,onChange:s=>l(s.target.value),placeholder:"Buscar por nombre o código...",className:"w-full pl-10 pr-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),e.jsxs("div",{className:"flex items-center space-x-3 bg-white p-2 rounded-lg shadow-sm border border-gray-200",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(Z,{className:`w-5 h-5 ${a?"text-blue-600":"text-gray-400"}`}),e.jsx("span",{className:"text-sm font-medium text-gray-700",children:"Ver solo activas"})]}),e.jsx(C,{checked:a,onChange:()=>v(!a),labelOff:"Mostrar todo",labelOn:"Solo activos",colorClass:"bg-blue-600"})]})]}),e.jsxs("div",{className:"bg-white rounded-lg shadow-md overflow-hidden",children:[e.jsxs("div",{className:"md:hidden divide-y divide-gray-200",children:[p&&e.jsx("div",{className:"p-4",children:e.jsx(k,{text:"Cargando productos..."})}),y&&e.jsxs("div",{className:"p-8 text-center text-red-500",children:["Error: ",_?.message]}),!p&&!y&&h.length===0&&e.jsxs("div",{className:"p-8 text-center text-gray-500",children:["No se encontraron productos",a?" activos.":"."]}),h.map(s=>e.jsxs("div",{className:"p-4 flex flex-col space-y-3",children:[e.jsx("div",{className:"flex justify-between items-start",children:e.jsxs("div",{className:"pr-4",children:[e.jsx("h3",{className:"text-sm font-bold text-gray-900 line-clamp-2",children:s.custom_title||s.name}),e.jsxs("p",{className:"text-xs text-gray-500 font-mono mt-1",children:["Cód: ",s.code]}),s.custom_title&&e.jsx("span",{className:"inline-block mt-1 text-[10px] text-blue-600 bg-blue-50 px-1.5 py-0.5 rounded border border-blue-100",children:"Personalizado"})]})}),e.jsxs("div",{className:"flex items-center justify-between pt-2 border-t border-gray-50",children:[e.jsx("div",{children:s.oferta?e.jsxs("span",{className:"inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800",children:[e.jsx(D,{className:"w-3 h-3 mr-1"}),"En Oferta"]}):e.jsxs("span",{className:"inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800",children:[e.jsx(A,{className:"w-3 h-3 mr-1"}),"Sin Oferta"]})}),e.jsxs("div",{className:"flex items-center space-x-3",children:[s.oferta&&e.jsx("button",{onClick:()=>d(s),className:"p-2 text-gray-400 hover:text-blue-600 bg-gray-50 rounded-full transition-colors cursor-pointer","aria-label":"Editar oferta",children:e.jsx(T,{className:"w-5 h-5"})}),e.jsx(C,{checked:s.oferta,onChange:()=>E(s.id),disabled:P})]})]})]},s.id))]}),e.jsx("div",{className:"hidden md:block overflow-x-auto",children:e.jsxs("table",{className:"min-w-full bg-white",children:[e.jsx("thead",{className:"bg-gray-100 border-b border-gray-300",children:e.jsxs("tr",{children:[e.jsx("th",{className:"py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase",children:"Código"}),e.jsx("th",{className:"py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase",children:"Descripción"}),e.jsx("th",{className:"py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase",children:"Estado Actual"}),e.jsx("th",{className:"py-3 px-4 text-center text-xs font-semibold text-gray-600 uppercase",children:"Acciones"})]})}),e.jsxs("tbody",{className:"divide-y divide-gray-200",children:[p&&e.jsx("tr",{children:e.jsx("td",{colSpan:"4",className:"p-0",children:e.jsx(k,{text:"Cargando productos..."})})}),y&&e.jsx("tr",{children:e.jsxs("td",{colSpan:"4",className:"p-8 text-center text-red-500",children:["Error: ",_?.message]})}),!p&&!y&&h.length===0&&e.jsx("tr",{children:e.jsxs("td",{colSpan:"4",className:"p-8 text-center text-gray-500",children:["No se encontraron productos",a?" activos.":"."]})}),h.map(s=>e.jsx(ae,{product:s,onToggle:()=>E(s.id),isToggling:P,onEdit:d},s.id))]})]})}),!a&&e.jsxs("div",{className:"p-4 text-center",children:[S&&e.jsx("button",{onClick:()=>z(),disabled:O,className:"mt-4 px-6 py-2 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 disabled:opacity-50 cursor-pointer",children:O?"Cargando...":"Cargar más productos"}),!S&&!p&&h.length>0&&e.jsx("p",{className:"text-gray-500 text-sm",children:"Fin de los resultados."})]})]}),o&&e.jsx(re,{product:o,onClose:()=>d(null),onSave:(s,r)=>G({productId:s,details:r}),isSaving:B})]})}export{fe as default};
