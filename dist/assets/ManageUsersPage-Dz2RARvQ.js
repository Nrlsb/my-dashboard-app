const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/exceljs.min-O_esO3hg.js","assets/vendor-qkC6yhPU.js","assets/excel-w3LXhgQu.js"])))=>i.map(i=>d[i]);
import{a as h,j as e,L as ae,_ as re}from"./index-CXBEGiSo.js";import{r as t,t as le,S as P,i as ne,W as oe,aa as ie,Q as de}from"./ui-libs-DRx-SISE.js";import{T as ce}from"./TestUserAnalyticsModal-BFZK-BbF.js";import{C as ue}from"./ConfirmationModal-BuDWuykL.js";import"./vendor-qkC6yhPU.js";const fe=()=>{const[i,T]=t.useState([]),[O,q]=t.useState(!0),[j,v]=t.useState(null),[N,l]=t.useState(null),[C,n]=t.useState(null),[d,I]=t.useState(""),[u,$]=t.useState(""),[B,k]=t.useState(!1),[V,_]=t.useState(!1),[a,S]=t.useState(null),[E,U]=t.useState(null),[o,A]=t.useState(""),[R,F]=t.useState(""),[L,z]=t.useState(!0),[W,g]=t.useState(!1),[m,p]=t.useState(null),x=t.useCallback(async s=>{try{v(null);const r=await h.getAllClients(s);T(r)}catch(r){v(r.message||"Error al cargar los clientes.")}finally{q(!1)}},[]);t.useEffect(()=>{const s=setTimeout(()=>{x(d)},500);return()=>clearTimeout(s)},[d,x]);const G=s=>{I(s.target.value)},J=t.useMemo(()=>{const s=i.map(r=>r.vendedor_nombre).filter(r=>r);return[...new Set(s)].sort()},[i]),M=t.useMemo(()=>u?i.filter(s=>s.vendedor_nombre===u):i,[i,u]),Q=s=>{S(s),A(""),F(""),l(null),n(null),k(!0)},f=()=>{k(!1),S(null)},H=s=>{U(s),_(!0)},K=()=>{_(!1),U(null)},X=async()=>{if(!o){l("La contraseña es requerida.");return}if(o.length<6){l("La contraseña debe tener al menos 6 caracteres.");return}if(o!==R){l("Las contraseñas no coinciden.");return}try{if(l(null),a.has_password?(await h.resetUserPassword(a.id,o),n(`Contraseña restablecida correctamente para ${a.full_name}.`)):(await h.assignClientPassword({a1_cod:a.a1_cod,password:o,email:a.email}),n(`Contraseña asignada correctamente a ${a.full_name}.`),x(d)),L)try{const s=(await re(async()=>{const{default:w}=await import("./exceljs.min-O_esO3hg.js").then(y=>y.e);return{default:w}},__vite__mapDeps([0,1,2]))).default,r=new s.Workbook,c=r.addWorksheet("Credenciales");c.columns=[{header:"Dato",key:"key",width:25},{header:"Valor",key:"value",width:40}],c.getRow(1).font={bold:!0,color:{argb:"FFFFFFFF"}},c.getRow(1).fill={type:"pattern",pattern:"solid",fgColor:{argb:"FF283A5A"}},c.addRows([{key:"Cliente",value:a.full_name},{key:"Código",value:a.codigo||a.a1_cod},{key:"Email",value:a.email},{key:"Contraseña",value:o},{key:"Fecha",value:new Date().toLocaleDateString()}]),c.eachRow((w,y)=>{y>1&&(w.font={size:12})});const se=await r.xlsx.writeBuffer(),te=new Blob([se],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),D=window.URL.createObjectURL(te),b=document.createElement("a");b.href=D,b.download=`Credenciales_${a.codigo||a.full_name}.xlsx`,b.click(),window.URL.revokeObjectURL(D)}catch(s){console.error("Error generando Excel:",s),l("Error al generar el archivo Excel, pero la contraseña se guardó.")}f(),setTimeout(()=>n(null),3e3)}catch(s){l(s.message||"Error al procesar la contraseña.")}},Y=s=>{p(s),g(!0)},Z=async()=>{if(m){g(!1);try{l(null),n(null),await h.deleteUser(m.id),n(`Usuario ${m.full_name} eliminado correctamente.`),x(d),setTimeout(()=>n(null),3e3)}catch(s){console.error(s),l(s.message||"Error al eliminar el usuario.")}finally{p(null)}}},ee=()=>{g(!1),p(null)};return O?e.jsx(ae,{text:"Cargando usuarios..."}):j?e.jsx("div",{className:"p-8 text-center",children:e.jsxs("div",{className:"text-red-600 bg-red-100 p-4 rounded-lg inline-block",children:["Error: ",j]})}):e.jsxs("div",{className:"p-4 sm:p-6 max-w-[1600px] mx-auto min-h-screen bg-gray-50",children:[e.jsx("h1",{className:"text-2xl sm:text-3xl font-bold text-gray-800 mb-6 text-center",children:"Gestión de Usuarios"}),C&&e.jsxs("div",{className:"mb-6 p-4 bg-green-100 border-l-4 border-green-500 text-green-700 flex items-center justify-center rounded shadow-sm animate-fade-in-down",children:[e.jsx(le,{className:"w-5 h-5 mr-2"}),e.jsx("span",{children:C})]}),e.jsxs("div",{className:"bg-white rounded-xl shadow-md overflow-hidden border border-gray-100",children:[e.jsx("div",{className:"p-4 sm:p-6 border-b border-gray-100 flex flex-col md:flex-row justify-between items-center gap-4 bg-gray-50/50",children:e.jsxs("div",{className:"flex flex-col md:flex-row gap-4 w-full md:w-auto flex-1",children:[e.jsxs("form",{className:"relative w-full md:max-w-md",onSubmit:s=>s.preventDefault(),autoComplete:"off",children:[e.jsx("div",{className:"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none",children:e.jsx(P,{className:"h-5 w-5 text-gray-400"})}),e.jsx("input",{type:"search",name:"search_users_query",id:"search_users_query",placeholder:"Buscar por nombre, email o código...",className:"pl-10 pr-4 py-2.5 w-full border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all shadow-sm",value:d,onChange:G,autoComplete:"off"})]}),e.jsxs("select",{className:"w-full md:w-64 px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 shadow-sm bg-white text-gray-700",value:u,onChange:s=>$(s.target.value),children:[e.jsx("option",{value:"",children:"Todos los Vendedores"}),J.map(s=>e.jsx("option",{value:s,children:s},s))]})]})}),e.jsx("div",{className:"w-full overflow-hidden",children:e.jsxs("table",{className:"w-full divide-y divide-gray-200 table-fixed",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{scope:"col",className:"w-[30%] px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider truncate",children:"Usuario"}),e.jsx("th",{scope:"col",className:"w-[10%] px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider hidden sm:table-cell truncate",children:"Código"}),e.jsx("th",{scope:"col",className:"w-[20%] px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider hidden md:table-cell truncate",children:"Email"}),e.jsx("th",{scope:"col",className:"w-[15%] px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider hidden lg:table-cell truncate",children:"Vendedor"}),e.jsx("th",{scope:"col",className:"w-[25%] px-4 py-3 text-right text-xs font-semibold text-gray-500 uppercase tracking-wider",children:"Acciones"})]})}),e.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:M.length>0?M.map(s=>e.jsxs("tr",{className:"hover:bg-blue-50/30 transition-colors duration-150",children:[e.jsx("td",{className:"px-4 py-3 overflow-hidden",children:e.jsxs("div",{className:"flex items-center min-w-0",children:[e.jsx("div",{className:"flex-shrink-0 h-9 w-9 hidden xs:block",children:e.jsx("div",{className:"h-9 w-9 rounded-full bg-gradient-to-br from-blue-100 to-blue-200 flex items-center justify-center text-blue-700 font-bold shadow-sm",children:s.full_name?.charAt(0).toUpperCase()||"U"})}),e.jsxs("div",{className:"ml-0 xs:ml-3 min-w-0 flex-1",children:[e.jsx("div",{className:"text-sm font-medium text-gray-900 truncate",title:s.full_name,children:s.full_name}),e.jsx("div",{className:"md:hidden text-xs text-gray-500 truncate",children:s.email})]})]})}),e.jsx("td",{className:"px-4 py-3 whitespace-nowrap hidden sm:table-cell",children:e.jsx("span",{className:"px-2 py-0.5 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800",children:s.a1_cod||"N/A"})}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-500 truncate hidden md:table-cell",title:s.email,children:s.email}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-500 truncate hidden lg:table-cell",title:s.vendedor_nombre,children:s.vendedor_nombre||"-"}),e.jsx("td",{className:"px-4 py-3 text-right text-sm font-medium whitespace-nowrap",children:e.jsxs("div",{className:"flex items-center justify-end gap-1 sm:gap-2",children:[e.jsxs("button",{onClick:()=>H(s),className:"text-white bg-blue-500 hover:bg-blue-600 font-medium rounded-lg text-xs px-2.5 py-1.5 transition-all shadow-sm focus:outline-none flex items-center gap-1",title:"Ver Análisis",children:[e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",className:"lucide lucide-bar-chart-2",children:[e.jsx("line",{x1:"18",x2:"18",y1:"20",y2:"10"}),e.jsx("line",{x1:"12",x2:"12",y1:"20",y2:"4"}),e.jsx("line",{x1:"6",x2:"6",y1:"20",y2:"14"})]}),e.jsx("span",{className:"hidden xl:inline",children:"Análisis"})]}),e.jsxs("button",{onClick:()=>Q(s),className:`text-white font-medium rounded-lg text-xs px-2.5 py-1.5 transition-all shadow-sm focus:outline-none flex items-center justify-center gap-1 ${s.has_password?"bg-indigo-600 hover:bg-indigo-700 focus:ring-4 focus:ring-indigo-300":"bg-green-600 hover:bg-green-700 focus:ring-4 focus:ring-green-300"}`,title:s.has_password?"Resetear":"Asignar",children:[s.has_password?e.jsx(ne,{className:"w-3.5 h-3.5"}):e.jsx(oe,{className:"w-3.5 h-3.5"}),e.jsx("span",{className:"hidden xl:inline",children:s.has_password?"Reset":"Asignar"})]}),!s.is_admin&&e.jsx("button",{onClick:()=>Y(s),className:"text-white bg-red-500 hover:bg-red-600 font-medium rounded-lg text-xs px-2.5 py-1.5 transition-all shadow-sm focus:outline-none flex items-center gap-1",title:"Eliminar Usuario",children:e.jsx(ie,{className:"w-3.5 h-3.5"})})]})})]},s.id)):e.jsx("tr",{children:e.jsx("td",{colSpan:"5",className:"px-6 py-10 text-center text-gray-500",children:e.jsxs("div",{className:"flex flex-col items-center justify-center",children:[e.jsx(P,{className:"h-10 w-10 text-gray-300 mb-3"}),e.jsx("p",{className:"text-lg font-medium",children:"No se encontraron usuarios"}),e.jsx("p",{className:"text-sm",children:"Intenta con otros filtros o términos de búsqueda."})]})})})})]})})]}),B&&e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center overflow-x-hidden overflow-y-auto outline-none focus:outline-none bg-black/50 backdrop-blur-sm transition-opacity",children:e.jsxs("div",{className:"relative w-full max-w-md mx-4 my-6",children:[e.jsxs("div",{className:"relative flex flex-col w-full bg-white border-0 rounded-xl shadow-2xl outline-none focus:outline-none animate-bounce-in",children:[e.jsxs("div",{className:"flex items-start justify-between p-5 border-b border-solid border-gray-200 rounded-t-xl bg-gray-50",children:[e.jsx("h3",{className:"text-xl font-bold text-gray-800",children:a?.has_password?"Restablecer Contraseña":"Asignar Nueva Contraseña"}),e.jsx("button",{className:"p-1 ml-auto bg-transparent border-0 text-gray-400 hover:text-gray-900 float-right text-3xl leading-none font-semibold outline-none focus:outline-none transition-colors",onClick:f,children:e.jsx("span",{className:"bg-transparent h-6 w-6 text-2xl block outline-none focus:outline-none",children:"×"})})]}),e.jsxs("div",{className:"relative p-6 flex-auto",children:[e.jsxs("p",{className:"my-2 text-gray-600 text-sm leading-relaxed mb-6",children:["Estás restableciendo la contraseña para el usuario:",e.jsx("br",{}),e.jsx("strong",{className:"text-gray-900 block mt-1 text-base",children:a?.full_name})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("input",{type:"text",readOnly:!0,className:"opacity-0 absolute w-0 h-0 -z-10",autoComplete:"username"}),e.jsx("input",{type:"password",readOnly:!0,className:"opacity-0 absolute w-0 h-0 -z-10",autoComplete:"current-password"}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"newPassword",className:"block text-sm font-medium text-gray-700 mb-1",children:"Nueva Contraseña"}),e.jsx("input",{type:"password",id:"newPassword",className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all outline-none",value:o,onChange:s=>A(s.target.value),placeholder:"Ingresa la nueva contraseña"})]}),e.jsx("input",{type:"password",id:"confirmPassword",className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all outline-none",value:R,onChange:s=>F(s.target.value),placeholder:"Repite la nueva contraseña"})]}),e.jsxs("div",{className:"flex items-center mt-2 p-2 bg-gray-50 rounded text-sm text-gray-700",children:[e.jsx("input",{id:"downloadCredentials",type:"checkbox",checked:L,onChange:s=>z(s.target.checked),className:"w-4 h-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500 cursor-pointer"}),e.jsx("label",{htmlFor:"downloadCredentials",className:"ml-2 block cursor-pointer select-none",children:"Descargar credenciales en Excel"})]}),N&&e.jsxs("div",{className:"text-red-600 text-sm bg-red-50 p-2 rounded flex items-start gap-2",children:[e.jsx(de,{className:"w-4 h-4 mt-0.5 flex-shrink-0"}),e.jsx("span",{children:N})]})]})]}),e.jsxs("div",{className:"flex items-center justify-end p-6 border-t border-solid border-gray-200 rounded-b-xl bg-gray-50",children:[e.jsx("button",{className:"text-gray-500 background-transparent font-bold uppercase px-6 py-2 text-sm outline-none focus:outline-none mr-2 mb-1 ease-linear transition-all duration-150 hover:bg-gray-200 rounded-lg",type:"button",onClick:f,children:"Cancelar"}),e.jsx("button",{className:"bg-indigo-600 text-white active:bg-indigo-700 font-bold uppercase text-sm px-6 py-3 rounded-lg shadow hover:shadow-lg outline-none focus:outline-none mr-1 mb-1 ease-linear transition-all duration-150 hover:bg-indigo-700",type:"button",onClick:X,children:"Guardar Cambios"})]})]})}),e.jsx(ce,{isOpen:V,onClose:K,userId:E?.id,userName:E?.full_name,isRegularUser:!0}),e.jsx(ue,{isOpen:W,onClose:ee,onConfirm:Z,title:"Eliminar Usuario",message:`¿Estás seguro de que deseas eliminar al usuario ${m?.full_name}? Esta acción borrará sus credenciales y datos del sistema.`,confirmText:"Eliminar",variant:"danger"})]})};export{fe as default};
