import{a as C,j as e,i as E,u as F,e as V,b as D,L as B}from"./index-C9spfAEE.js";import{r as d,X as L,f as G,u as I,j as M,V as z,a0 as U,i as A,a2 as _,a3 as O,a4 as R,U as $,a5 as q,w as H,Y as X,a6 as Y,y as J,c as T,A as K}from"./ui-libs-Bu6C6VT7.js";import"./vendor-qkC6yhPU.js";const Q=({isOpen:t,onClose:g,clientId:x,clientName:y})=>{const[n,u]=d.useState(!0),[p,c]=d.useState(!1),[N,w]=d.useState([]),[b,m]=d.useState([]),[k,h]=d.useState(null),[f,s]=d.useState(null);d.useEffect(()=>{t&&x?l():(s(null),h(null))},[t,x]);const l=async()=>{u(!0),h(null);try{const[r,a]=await Promise.all([C.getVendedorProductGroups(),C.getClientPermissions(x)]);w(r),m(a)}catch(r){console.error(r),h("Error al cargar datos. Intente nuevamente.")}finally{u(!1)}},v=r=>{m(a=>{const S=a.find(o=>o.group===r);return S?S.source==="admin"?a:a.filter(o=>o.group!==r):[...a,{group:r,source:"vendedor"}]})},P=async()=>{c(!0),h(null);try{const r=b.filter(a=>a.source==="vendedor").map(a=>a.group);await C.updateClientPermissions(x,r),s("Permisos actualizados correctamente."),setTimeout(()=>{s(null),g()},1500)}catch(r){console.error(r),h(r.message||"Error al guardar cambios.")}finally{c(!1)}};return t?e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm p-4 animate-fade-in",children:e.jsxs("div",{className:"bg-white w-full max-w-4xl rounded-xl shadow-2xl flex flex-col max-h-[90vh] overflow-hidden",children:[e.jsxs("div",{className:"flex items-center justify-between p-6 border-b border-gray-100 bg-gray-50/50",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold text-gray-800",children:"Restricciones de Productos"}),e.jsxs("p",{className:"text-sm text-gray-500 mt-1",children:["Gestionando restricciones para: ",e.jsx("span",{className:"font-semibold text-blue-600",children:y})]})]}),e.jsx("button",{onClick:g,className:"p-2 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-lg transition-colors",children:e.jsx(L,{className:"w-6 h-6"})})]}),e.jsx("div",{className:"flex-1 overflow-y-auto p-6 bg-white relative",children:n?e.jsxs("div",{className:"flex flex-col items-center justify-center h-64",children:[e.jsx("div",{className:"animate-spin rounded-full h-10 w-10 border-b-2 border-blue-600 mb-4"}),e.jsx("p",{className:"text-gray-500",children:"Cargando grupos..."})]}):e.jsxs(e.Fragment,{children:[k&&e.jsxs("div",{className:"mb-6 p-4 bg-red-50 text-red-700 rounded-lg flex items-center gap-3",children:[e.jsx(G,{className:"w-5 h-5 flex-shrink-0"}),e.jsx("span",{children:k})]}),f&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-white/90 z-10",children:e.jsxs("div",{className:"flex flex-col items-center animate-bounce-in",children:[e.jsx(I,{className:"w-16 h-16 text-green-500 mb-4"}),e.jsx("p",{className:"text-xl font-semibold text-gray-800",children:f})]})}),e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4",children:N.map(r=>{const a=r.product_group,S=b.find(j=>j.group===a),o=!!S,i=S?.source==="admin";return e.jsxs("label",{className:`
                                                relative flex items-center p-4 rounded-lg border transition-all cursor-pointer
                                                ${i?"bg-gray-50 border-gray-200 opacity-75 cursor-not-allowed":o?"bg-red-50 border-red-200 shadow-sm":"bg-white border-gray-200 hover:border-blue-300 hover:shadow-sm"}
                                            `,children:[e.jsx("input",{type:"checkbox",className:"sr-only",checked:o,onChange:()=>!i&&v(a),disabled:i}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsx("span",{className:`text-sm font-medium truncate ${o?"text-red-700":"text-gray-700"}`,children:a}),i&&e.jsx(M,{className:"w-4 h-4 text-gray-400"})]}),e.jsx("p",{className:"text-xs text-gray-500 truncate",children:r.brand||"General"})]}),e.jsx("div",{className:`
                                                w-5 h-5 rounded border flex items-center justify-center ml-3 transition-colors
                                                ${o?i?"bg-gray-400 border-gray-400":"bg-red-500 border-red-500":"border-gray-300"}
                                            `,children:o&&e.jsx(L,{className:"w-3.5 h-3.5 text-white"})})]},a)})})]})}),e.jsxs("div",{className:"p-6 border-t border-gray-100 bg-gray-50 flex justify-between items-center",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm text-gray-500",children:[e.jsx(z,{className:"w-4 h-4"}),e.jsxs("span",{children:[e.jsx(M,{className:"w-3 h-3 inline mx-1"})," Restringido por Admin (Bloqueado)"]})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx("button",{onClick:g,className:"px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-lg font-medium text-sm transition-colors",disabled:p,children:"Cancelar"}),e.jsx("button",{onClick:P,disabled:p||n,className:"px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium text-sm shadow-md hover:shadow-lg transition-all disabled:opacity-50 flex items-center gap-2",children:p?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin"}),"Guardando..."]}):e.jsxs(e.Fragment,{children:[e.jsx(U,{className:"w-4 h-4"}),"Guardar Cambios"]})})]})]})]})}):null},W={"/dashboard":"Inicio","/login":"Iniciar Sesión","/new-order":"Nuevo Pedido","/price-list":"Lista de Precios","/products":"Productos","/cart":"Carrito","/orders":"Mis Pedidos","/profile":"Mi Perfil","/admin/dashboard":"Panel Admin","/admin/users":"Gestión Usuarios","/admin/products":"Gestión Productos"},Z=({stats:t,clientName:g,onManagePermissions:x,availableBrands:y=[],selectedBrands:n=[],onBrandsChange:u})=>{const[p,c]=A.useState(!1),[N,w]=A.useState(""),[b,m]=A.useState(n);if(A.useEffect(()=>{m(n)},[n]),!t)return null;const k=s=>{m(l=>l.includes(s)?l.filter(v=>v!==s):[...l,s])},h=()=>{u(b),c(!1)},f=y.filter(s=>s.toLowerCase().includes(N.toLowerCase()));return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6",children:[e.jsxs("div",{className:"bg-white p-6 rounded-xl shadow-sm border border-gray-100",children:[e.jsxs("div",{className:"flex items-center gap-3 text-blue-700 mb-2",children:[e.jsx("div",{className:"p-2 bg-blue-100 rounded-lg",children:e.jsx(_,{className:"w-5 h-5"})}),e.jsx("span",{className:"text-sm font-semibold uppercase tracking-wider",children:"Visitas Totales"})]}),e.jsx("p",{className:"text-3xl font-bold text-gray-900 mt-2",children:t.totalVisits})]}),e.jsxs("div",{className:"bg-white p-6 rounded-xl shadow-sm border border-gray-100",children:[e.jsxs("div",{className:"flex items-center gap-3 text-green-700 mb-2",children:[e.jsx("div",{className:"p-2 bg-green-100 rounded-lg",children:e.jsx(O,{className:"w-5 h-5"})}),e.jsx("span",{className:"text-sm font-semibold uppercase tracking-wider",children:"Pedidos Totales"})]}),e.jsxs("p",{className:"text-3xl font-bold text-gray-900 mt-2",children:[t.totalOrders||0,e.jsxs("span",{className:"text-sm font-normal text-green-600 ml-2",children:["(",t.confirmedOrders||0," Conf.)"]})]})]}),e.jsxs("div",{className:"bg-white p-6 rounded-xl shadow-sm border border-gray-100",children:[e.jsxs("div",{className:"flex items-center gap-3 text-amber-700 mb-2",children:[e.jsx("div",{className:"p-2 bg-amber-100 rounded-lg",children:e.jsx(R,{className:"w-5 h-5"})}),e.jsx("span",{className:"text-sm font-semibold uppercase tracking-wider",children:"Más Pedido"})]}),e.jsx("p",{className:"text-sm font-bold text-gray-900 mt-2 line-clamp-2",title:t.mostBoughtProduct,children:t.mostBoughtProduct||"N/A"})]}),e.jsxs("div",{className:"bg-white p-6 rounded-xl shadow-sm border border-gray-100",children:[e.jsxs("div",{className:"flex items-center gap-3 text-purple-700 mb-2",children:[e.jsx("div",{className:"p-2 bg-purple-100 rounded-lg",children:e.jsx($,{className:"w-5 h-5"})}),e.jsx("span",{className:"text-sm font-semibold uppercase tracking-wider",children:"Perfil del Cliente"})]}),e.jsx("p",{className:"text-lg font-medium text-gray-900 mt-1 truncated",children:g}),e.jsxs("p",{className:"text-xs text-gray-500",children:["ID: ",t.a1_cod||t.codigo||"-"]}),x&&e.jsxs("button",{onClick:x,className:"mt-3 w-full py-1.5 bg-purple-50 text-purple-700 rounded-lg text-xs font-medium hover:bg-purple-100 transition-colors flex items-center justify-center gap-2",children:[e.jsx(q,{className:"w-3.5 h-3.5"}),"Gestionar Permisos"]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"bg-white rounded-xl shadow-sm border border-gray-100 p-6",children:[e.jsxs("h3",{className:"text-lg font-bold text-gray-900 mb-4 flex items-center gap-2",children:[e.jsx(H,{className:"w-5 h-5 text-gray-400"}),"Detalles de Actividad"]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex justify-between items-center py-2 border-b border-gray-50",children:[e.jsx("span",{className:"text-gray-500",children:"Última Visita"}),e.jsx("span",{className:"font-medium",children:t.lastVisit?new Date(t.lastVisit).toLocaleString():"Nunca"})]}),e.jsxs("div",{className:"flex justify-between items-center py-2 border-b border-gray-50",children:[e.jsx("span",{className:"text-gray-500",children:"Producto Más Visto"}),e.jsx("span",{className:"font-medium text-blue-600 text-right max-w-[200px] truncate",title:t.mostViewedProduct,children:t.mostViewedProduct||"N/A"})]})]})]}),e.jsxs("div",{className:"bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden",children:[e.jsx("div",{className:"p-6 border-b border-gray-100",children:e.jsx("h3",{className:"text-lg font-bold text-gray-900",children:"Páginas Más Vistas"})}),t.topPages&&t.topPages.length>0?e.jsx("ul",{className:"divide-y divide-gray-100",children:t.topPages.map((s,l)=>e.jsxs("li",{className:"p-4 hover:bg-gray-50 transition flex justify-between items-center",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"w-6 h-6 flex items-center justify-center bg-gray-100 text-gray-600 rounded-full text-xs font-bold",children:l+1}),e.jsx("span",{className:"text-gray-700 font-medium",title:s.path,children:W[s.path]||s.path})]}),e.jsxs("span",{className:"px-3 py-1 bg-blue-50 text-blue-700 text-sm font-semibold rounded-full",children:[s.count," visitas"]})]},l))}):e.jsx("p",{className:"p-6 text-gray-500 text-center",children:"Sin actividad registrada."})]})]}),e.jsxs("div",{className:"bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden",children:[e.jsxs("div",{className:"p-6 border-b border-gray-100",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"text-lg font-bold text-gray-900",children:"Productos Más Pedidos"}),e.jsxs("div",{className:"relative",children:[e.jsxs("button",{onClick:()=>c(!p),className:`p-2 rounded-lg border transition-colors flex items-center gap-2 text-sm font-medium ${n.length>0?"bg-blue-50 border-blue-200 text-blue-700":"bg-white border-gray-200 text-gray-600 hover:bg-gray-50"}`,children:[e.jsx(X,{className:"w-4 h-4"}),"Filtrar Marcas",n.length>0&&e.jsx("span",{className:"w-5 h-5 flex items-center justify-center bg-blue-600 text-white rounded-full text-[10px]",children:n.length})]}),p&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"fixed inset-0 z-20",onClick:()=>c(!1)}),e.jsxs("div",{className:"absolute right-0 mt-2 w-64 bg-white rounded-xl shadow-xl border border-gray-200 z-30 overflow-hidden",children:[e.jsx("div",{className:"p-3 border-b border-gray-100",children:e.jsx("input",{type:"text",placeholder:"Buscar marca...",className:"w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500",value:N,onChange:s=>w(s.target.value),autoFocus:!0})}),e.jsx("div",{className:"max-h-60 overflow-y-auto",children:f.length>0?e.jsx("div",{className:"p-1",children:f.map(s=>e.jsxs("button",{onClick:()=>k(s),className:"w-full flex items-center justify-between px-3 py-2 hover:bg-gray-50 rounded-lg transition-colors text-left",children:[e.jsx("span",{className:"text-sm text-gray-700 truncate",children:s}),b.includes(s)&&e.jsx(Y,{className:"w-4 h-4 text-blue-600"})]},s))}):e.jsx("div",{className:"p-4 text-center text-sm text-gray-500",children:"No se encontraron marcas."})}),e.jsxs("div",{className:"p-2 border-t border-gray-100 bg-gray-50 space-y-2",children:[e.jsx("button",{onClick:h,className:"w-full py-2 bg-blue-600 text-white rounded-lg text-sm font-semibold hover:bg-blue-700 transition-colors shadow-sm",children:"Aplicar Filtros"}),b.length>0&&e.jsx("button",{onClick:()=>{m([]),u([]),c(!1)},className:"w-full py-1 text-xs font-medium text-gray-500 hover:text-red-600 transition-colors",children:"Limpiar Todo"})]})]})]})]})]}),n.length>0&&e.jsx("div",{className:"flex flex-wrap gap-2",children:n.map(s=>e.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-1 bg-blue-50 text-blue-700 rounded-md text-xs font-medium border border-blue-100",children:[s,e.jsx("button",{onClick:()=>{const l=n.filter(v=>v!==s);u(l)},className:"hover:text-blue-900",children:e.jsx(L,{className:"w-3 h-3"})})]},s))})]}),t.topBoughtProducts&&t.topBoughtProducts.length>0?e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full text-left text-sm",children:[e.jsx("thead",{className:"bg-gray-50 text-xs font-semibold text-gray-500 uppercase tracking-wider",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-6 py-3",children:"Producto"}),e.jsx("th",{className:"px-6 py-3 text-center",children:"Cant."})]})}),e.jsx("tbody",{className:"divide-y divide-gray-100",children:t.topBoughtProducts.map((s,l)=>e.jsxs("tr",{className:"hover:bg-gray-50 transition",children:[e.jsxs("td",{className:"px-6 py-4",children:[e.jsx("div",{className:"font-medium text-gray-800",children:s.description}),e.jsxs("div",{className:"text-[10px] text-gray-500",children:["ID: ",s.product_id]})]}),e.jsx("td",{className:"px-6 py-4 text-center",children:e.jsx("span",{className:"px-3 py-1 bg-green-50 text-green-700 font-bold rounded-full",children:parseFloat(s.qty).toLocaleString()})})]},l))})]})}):e.jsx("p",{className:"p-6 text-gray-500 text-center",children:"Sin pedidos registrados."})]}),e.jsxs("div",{className:"bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden lg:col-span-2",children:[e.jsxs("div",{className:"p-6 border-b border-gray-100 flex justify-between items-center",children:[e.jsx("h3",{className:"text-lg font-bold text-gray-900",children:"Historial de Descargas (Listas de Precio)"}),e.jsx(J,{className:"w-5 h-5 text-gray-400"})]}),t.downloads&&t.downloads.length>0?e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full text-left",children:[e.jsx("thead",{className:"bg-gray-50 text-xs font-semibold text-gray-500 uppercase tracking-wider",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-6 py-3",children:"Fecha"}),e.jsx("th",{className:"px-6 py-3",children:"Filtros Utilizados"}),e.jsx("th",{className:"px-6 py-3",children:"Formato"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-100",children:t.downloads.map((s,l)=>e.jsxs("tr",{className:"hover:bg-gray-50 transition",children:[e.jsxs("td",{className:"px-6 py-4 whitespace-nowrap",children:[e.jsx("div",{className:"text-sm font-medium text-gray-900",children:new Date(s.created_at).toLocaleDateString()}),e.jsx("div",{className:"text-xs text-gray-500",children:new Date(s.created_at).toLocaleTimeString()})]}),e.jsx("td",{className:"px-6 py-4",children:e.jsxs("div",{className:"flex flex-wrap gap-2",children:[s.filters?.searchTerm&&e.jsxs("span",{className:"inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800",children:["Busq: ",s.filters.searchTerm]}),s.filters?.brands&&s.filters.brands.length>0&&e.jsxs("span",{className:"inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-purple-100 text-purple-800",children:["Marcas: ",s.filters.brands.join(", ")]}),s.filters?.onlyModifiedPrices&&e.jsx("span",{className:"inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-yellow-100 text-yellow-800",children:"Solo Modif."}),!s.filters?.searchTerm&&(!s.filters?.brands||s.filters.brands.length===0)&&!s.filters?.onlyModifiedPrices&&e.jsx("span",{className:"text-xs text-gray-400 italic",children:"Todo el catálogo"})]})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500 uppercase",children:s.format||"Excel"})]},l))})]})}):e.jsx("div",{className:"p-8 text-center text-gray-500",children:"No se han registrado descargas recientes."})]})]})]})};function re(){const{userId:t}=E(),g=F(),[x]=V(),y=x.get("name")||"Cliente",[n,u]=d.useState(null),[p,c]=d.useState(!0),[N,w]=d.useState(null),[b,m]=d.useState(!1),[k,h]=d.useState([]),[f,s]=d.useState([]),[l,v]=d.useState(!0),{user:P}=D(),r=x.get("type")==="test";d.useEffect(()=>{t&&a()},[t]);const a=async()=>{c(!0);try{const i=await C.getUserOrderedBrands(t);h(i.data||[]),await o([])}catch(i){console.error("Error initializing analytics data:",i),w("No se pudo cargar la información del cliente.")}finally{c(!1),v(!1)}},S=i=>{s(i),o(i)},o=async(i=f)=>{l||c(!0),w(null);try{let j;P?.role==="admin"||P?.role==="marketing"||P?.role==="test_user"?r?j=await C.getTestUserAnalytics(t,i):j=await C.getUserAnalytics(t,i):j=await C.getVendedorClientAnalytics(t,i),u(j.data)}catch(j){console.error("Error fetching analytics:",j),w("No se pudo cargar la información del cliente.")}finally{c(!1)}};return p?e.jsx("div",{className:"flex justify-center items-center min-h-screen bg-gray-50",children:e.jsx(B,{text:"Cargando análisis..."})}):N?e.jsx("div",{className:"flex flex-col justify-center items-center min-h-screen bg-gray-50 p-4",children:e.jsxs("div",{className:"bg-white p-8 rounded-lg shadow-md text-center max-w-md w-full",children:[e.jsx("div",{className:"text-red-500 mb-4 mx-auto w-12 h-12 flex items-center justify-center bg-red-100 rounded-full",children:e.jsx(T,{className:"w-6 h-6"})}),e.jsx("h2",{className:"text-xl font-bold text-gray-800 mb-2",children:"Error"}),e.jsx("p",{className:"text-gray-600 mb-6",children:N}),e.jsx("button",{onClick:()=>g("/vendedor-clients"),className:"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition",children:"Volver a Clientes"})]})}):e.jsxs("div",{className:"min-h-screen bg-gray-50 pb-12",children:[e.jsx("header",{className:"bg-white shadow-sm sticky top-0 z-10",children:e.jsx("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("button",{onClick:()=>g(-1),className:"mr-4 p-2 rounded-full hover:bg-gray-100 text-gray-600 transition",children:e.jsx(K,{className:"w-6 h-6"})}),e.jsxs("div",{children:[e.jsxs("h1",{className:"text-xl font-bold text-gray-900 flex items-center gap-2",children:[e.jsx(T,{className:"w-5 h-5 text-blue-600"}),"Análisis Detallado"]}),e.jsx("p",{className:"text-sm text-gray-500",children:y})]})]})})}),e.jsx("main",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8",children:n&&e.jsx(Z,{stats:n,clientName:y,onManagePermissions:P?.role==="admin"||P?.role==="vendedor"?()=>m(!0):null,availableBrands:k,selectedBrands:f,onBrandsChange:S})}),e.jsx(Q,{isOpen:b,onClose:()=>m(!1),clientId:t,clientName:y})]})}export{re as default};
