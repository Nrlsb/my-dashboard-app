import{b as z,j as s,L as U,a as p}from"./index-DwNA7lLh.js";import{r as o}from"./ui-libs-CgXQafC0.js";import{C as L}from"./CustomSelect-DcCyQmdN.js";import"./vendor-qkC6yhPU.js";const J=()=>{const{user:t}=z(),[_,E]=o.useState([]),[h,P]=o.useState(""),[A,D]=o.useState([]),[a,C]=o.useState(""),[g,m]=o.useState([]),[b,G]=o.useState(""),[F,f]=o.useState(!1),[v,d]=o.useState(!1),[S,c]=o.useState(null),[N,j]=o.useState(""),[n,y]=o.useState("search"),[w,T]=o.useState([]),[l,k]=o.useState(null);o.useEffect(()=>{(async()=>{if(!t||!t.is_admin){c("Acceso denegado. Requiere permisos de administrador."),d(!1);return}try{d(!0);const[r,i,u]=await Promise.all([p.getAdminUsers(),p.getAdminProductGroups(),p.getAdminSellers()]);E(r),D(i),T(u),c(null)}catch(r){c("Error al cargar datos iniciales. Asegúrese de tener permisos de administrador."),console.error(r)}finally{d(!1)}})()},[t]),o.useEffect(()=>{if(!a||!t||!t.is_admin){m([]);return}if(a==="ALL_CLIENTS"){m([]);return}(async()=>{try{d(!0),c(null);const r=await p.getDeniedProductGroups(a);m(r)}catch(r){c("Error al cargar los permisos para el cliente seleccionado."),console.error(r)}finally{d(!1)}})()},[a,t]);const $=e=>{m(r=>r.includes(e)?r.filter(i=>i!==e):[...r,e])},O=async()=>{if(!a){c("Por favor, seleccione un cliente primero.");return}if(!t||!t.is_admin){c("Acceso denegado. Requiere permisos de administrador para guardar.");return}try{d(!0),c(null),j(""),a==="ALL_CLIENTS"&&l?(await p.updateVendorGroupPermissions(l.codigo,g),j(`Permisos actualizados para TODOS los clientes de ${l.nombre} exitosamente.`)):(await p.updateUserGroupPermissions(a,g),j("Permisos guardados con éxito."))}catch(e){c("Error al guardar los permisos."),console.error(e)}finally{d(!1)}},I=_.filter(e=>n==="seller"?l?e.vendedor_codigo&&String(e.vendedor_codigo).trim()===String(l.codigo).trim():!1:e.full_name&&e.full_name.toLowerCase().includes(h.toLowerCase())||e.email&&e.email.toLowerCase().includes(h.toLowerCase())||e.a1_cod&&e.a1_cod.toLowerCase().includes(h.toLowerCase())),x=A.filter(e=>e.product_group&&e.product_group.toLowerCase().includes(b.toLowerCase())||e.brand&&e.brand.toLowerCase().includes(b.toLowerCase())),R=e=>{const r=e.target.checked;f(r);const i=x.map(u=>u.product_group);m(r?u=>[...new Set([...u,...i])]:u=>u.filter(V=>!i.includes(V)))};return o.useEffect(()=>{x.length>0&&x.every(e=>g.includes(e.product_group))?f(!0):f(!1)},[x,g]),v&&!S?s.jsx(U,{text:"Cargando..."}):S?s.jsx("div",{className:"text-center p-8 text-red-500",children:S}):!t||!t.is_admin?s.jsx("div",{className:"text-center p-8 text-red-500",children:"Acceso denegado. No tiene permisos de administrador para ver esta página."}):s.jsxs("div",{className:"p-8 max-w-4xl mx-auto bg-gray-50 rounded-lg shadow-md",children:[s.jsx("h2",{className:"text-center mb-8 text-gray-800",children:"Gestionar Permisos por Grupo de Producto"}),N&&s.jsx("p",{className:"bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded relative mb-4",children:N}),s.jsxs("div",{className:"flex border-b border-gray-200 mb-6",children:[s.jsx("button",{className:`px-6 py-3 font-medium text-sm focus:outline-none ${n==="search"?"border-b-2 border-blue-500 text-blue-600":"text-gray-500 hover:text-gray-700"}`,onClick:()=>y("search"),children:"Buscar Cliente"}),s.jsx("button",{className:`px-6 py-3 font-medium text-sm focus:outline-none ${n==="seller"?"border-b-2 border-blue-500 text-blue-600":"text-gray-500 hover:text-gray-700"}`,onClick:()=>y("seller"),children:"Por Vendedor"})]}),s.jsxs("div",{className:"mb-8 flex flex-col items-stretch gap-3",children:[n==="search"&&s.jsxs(s.Fragment,{children:[s.jsx("label",{htmlFor:"user-search",className:"font-bold",children:"Buscar Cliente:"}),s.jsx("input",{type:"text",id:"user-search",value:h,onChange:e=>P(e.target.value),placeholder:"Filtrar por nombre, email o código...",className:"p-2 rounded border border-gray-300 w-full"})]}),n==="seller"&&s.jsxs(s.Fragment,{children:[s.jsx("label",{htmlFor:"seller-select",className:"font-bold",children:"Seleccionar Vendedor:"}),s.jsx(L,{options:w.map(e=>({label:`${e.nombre} (Cod: ${e.codigo})`,value:e.codigo})),value:l?l.codigo:"",onChange:e=>{const r=w.find(i=>i.codigo===e);k(r),C("")},placeholder:"-- Seleccione un vendedor --"})]}),s.jsx("label",{htmlFor:"client-select",className:"font-bold",children:"Seleccionar Cliente:"}),s.jsx(L,{options:[...n==="seller"&&l?[{label:"-- TODOS LOS CLIENTES DEL VENDEDOR --",value:"ALL_CLIENTS"}]:[],...I.map(e=>({label:`${e.full_name} (${e.email||"Sin Email"})`,value:e.id}))],value:a,onChange:e=>C(e),placeholder:n==="seller"&&!l?"-- Primero seleccione un vendedor --":"-- Seleccione un cliente --",disabled:n==="seller"&&!l})]}),a&&s.jsxs("div",{className:"mt-4 p-6 border border-gray-200 rounded-lg bg-white",children:[a==="ALL_CLIENTS"&&l&&s.jsx("div",{className:"bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6",children:s.jsxs("div",{className:"flex",children:[s.jsx("div",{className:"flex-shrink-0",children:s.jsx("svg",{className:"h-5 w-5 text-yellow-400",viewBox:"0 0 20 20",fill:"currentColor",children:s.jsx("path",{fillRule:"evenodd",d:"M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z",clipRule:"evenodd"})})}),s.jsx("div",{className:"ml-3",children:s.jsxs("p",{className:"text-sm text-yellow-700",children:["Estás editando los permisos para ",s.jsx("strong",{children:"TODOS"})," los clientes de ",s.jsx("strong",{children:l.nombre}),".",s.jsx("br",{}),"Las restricciones que selecciones abajo se aplicarán a todos sus clientes, sobrescribiendo sus configuraciones actuales."]})})]})}),s.jsxs("div",{className:"mb-6 flex items-center gap-4",children:[s.jsx("label",{htmlFor:"product-group-filter",className:"font-bold",children:"Filtrar Grupos:"}),s.jsx("input",{type:"text",id:"product-group-filter",value:b,onChange:e=>G(e.target.value),placeholder:"Filtrar por grupo o marca...",className:"p-2 rounded border border-gray-300 flex-grow"})]}),s.jsxs("div",{className:"mb-4 flex items-center gap-2",children:[s.jsx("input",{type:"checkbox",id:"select-all-groups",checked:F,onChange:R,className:"w-5 h-5"}),s.jsx("label",{htmlFor:"select-all-groups",className:"font-bold",children:"Seleccionar todos los grupos filtrados"})]}),s.jsx("h3",{className:"mt-0 mb-6 border-b pb-4 text-xl font-semibold text-gray-700",children:"Grupos de Productos Denegados"}),s.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 mb-8",children:x.map(e=>s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("input",{type:"checkbox",id:`group-${e.product_group}`,checked:g.includes(e.product_group),onChange:()=>$(e.product_group),className:"w-5 h-5"}),s.jsxs("label",{htmlFor:`group-${e.product_group}`,children:[e.product_group," ",s.jsxs("span",{className:"text-gray-600 text-sm ml-1",children:["(",e.brand,")"]})]})]},e.product_group))}),s.jsx("button",{onClick:O,disabled:v,className:"px-6 py-3 bg-blue-600 text-white font-semibold rounded-md hover:bg-blue-700 transition-colors duration-200 disabled:bg-gray-400 disabled:cursor-not-allowed",children:"Guardar Permisos"})]})]})};export{J as default};
