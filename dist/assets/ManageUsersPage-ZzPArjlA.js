const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/exceljs.min-O_esO3hg.js","assets/vendor-qkC6yhPU.js","assets/excel-w3LXhgQu.js"])))=>i.map(i=>d[i]);
import{a as b,j as e,L as ne,_ as P}from"./index-DvDn8rgr.js";import{r as t,u as oe,S as I,y as ie,j as de,W as ce,ab as ue,f as me}from"./ui-libs-Bu6C6VT7.js";import{T as xe}from"./TestUserAnalyticsModal-B1aVhZW2.js";import{C as he}from"./ConfirmationModal-BzuMSYga.js";import"./vendor-qkC6yhPU.js";const ye=()=>{const[m,q]=t.useState([]),[B,$]=t.useState(!0),[k,C]=t.useState(null),[E,l]=t.useState(null),[S,o]=t.useState(null),[x,V]=t.useState(""),[h,W]=t.useState(""),[z,U]=t.useState(!1),[G,R]=t.useState(!1),[a,A]=t.useState(null),[F,L]=t.useState(null),[d,D]=t.useState(""),[T,O]=t.useState(""),[M,J]=t.useState(!0),[H,w]=t.useState(!1),[g,y]=t.useState(null),p=t.useCallback(async s=>{try{C(null);const r=await b.getAllClients(s);q(r)}catch(r){C(r.message||"Error al cargar los clientes.")}finally{$(!1)}},[]);t.useEffect(()=>{const s=setTimeout(()=>{p(x)},500);return()=>clearTimeout(s)},[x,p]);const K=s=>{V(s.target.value)},Q=t.useMemo(()=>{const s=m.map(r=>r.vendedor_nombre).filter(r=>r);return[...new Set(s)].sort()},[m]),j=t.useMemo(()=>h?m.filter(s=>s.vendedor_nombre===h):m,[m,h]),X=s=>{A(s),D(""),O(""),l(null),o(null),U(!0)},v=()=>{U(!1),A(null)},Y=s=>{L(s),R(!0)},Z=()=>{R(!1),L(null)},ee=async()=>{if(!d){l("La contraseña es requerida.");return}if(d.length<6){l("La contraseña debe tener al menos 6 caracteres.");return}if(d!==T){l("Las contraseñas no coinciden.");return}try{if(l(null),a.has_password?(await b.resetUserPassword(a.id,d),o(`Contraseña restablecida correctamente para ${a.full_name}.`)):(await b.assignClientPassword({a1_cod:a.a1_cod,password:d,email:a.email,is_vendedor:a.role==="vendedor"}),o(`Contraseña asignada correctamente a ${a.full_name}.`),p(x)),M)try{const s=(await P(async()=>{const{default:c}=await import("./exceljs.min-O_esO3hg.js").then(i=>i.e);return{default:c}},__vite__mapDeps([0,1,2]))).default,r=new s.Workbook,n=r.addWorksheet("Credenciales");n.columns=[{header:"Dato",key:"key",width:25},{header:"Valor",key:"value",width:40}],n.getRow(1).font={bold:!0,color:{argb:"FFFFFFFF"}},n.getRow(1).fill={type:"pattern",pattern:"solid",fgColor:{argb:"FF283A5A"}},n.addRows([{key:"Cliente",value:a.full_name},{key:"Código",value:a.codigo||a.a1_cod},{key:"Email",value:a.email},{key:"Contraseña",value:d},{key:"Fecha",value:new Date().toLocaleDateString()}]),n.eachRow((c,i)=>{i>1&&(c.font={size:12})});const N=await r.xlsx.writeBuffer(),_=new Blob([N],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),f=window.URL.createObjectURL(_),u=document.createElement("a");u.href=f,u.download=`Credenciales_${a.codigo||a.full_name}.xlsx`,u.click(),window.URL.revokeObjectURL(f)}catch(s){console.error("Error generando Excel:",s),l("Error al generar el archivo Excel, pero la contraseña se guardó.")}v(),setTimeout(()=>o(null),3e3)}catch(s){l(s.message||"Error al procesar la contraseña.")}},se=s=>{y(s),w(!0)},te=async()=>{if(g){w(!1);try{l(null),o(null),await b.deleteUser(g.id),o(`Usuario ${g.full_name} eliminado correctamente.`),p(x),setTimeout(()=>o(null),3e3)}catch(s){console.error(s),l(s.message||"Error al eliminar el usuario.")}finally{y(null)}}},ae=()=>{w(!1),y(null)},re=async()=>{try{const s=(await P(async()=>{const{default:i}=await import("./exceljs.min-O_esO3hg.js").then(le=>le.e);return{default:i}},__vite__mapDeps([0,1,2]))).default,r=new s.Workbook,n=r.addWorksheet("Usuarios");n.columns=[{header:"Nombre",key:"full_name",width:40},{header:"Código",key:"a1_cod",width:20},{header:"Contraseña Temporal",key:"temp_pass",width:30}],n.getRow(1).font={bold:!0,color:{argb:"FFFFFFFF"}},n.getRow(1).fill={type:"pattern",pattern:"solid",fgColor:{argb:"FF283A5A"}};const N=j.map(i=>({full_name:i.full_name,a1_cod:i.a1_cod||i.codigo,temp_pass:""}));n.addRows(N);const _=await r.xlsx.writeBuffer(),f=new Blob([_],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),u=window.URL.createObjectURL(f),c=document.createElement("a");c.href=u,c.download=`Lista_Usuarios_${new Date().toLocaleDateString().replace(/\//g,"-")}.xlsx`,c.click(),window.URL.revokeObjectURL(u),o("Lista de usuarios descargada correctamente."),setTimeout(()=>o(null),3e3)}catch(s){console.error("Error generando Excel:",s),l("Error al generar el archivo Excel.")}};return B?e.jsx(ne,{text:"Cargando usuarios..."}):k?e.jsx("div",{className:"p-8 text-center",children:e.jsxs("div",{className:"text-red-600 bg-red-100 p-4 rounded-lg inline-block",children:["Error: ",k]})}):e.jsxs("div",{className:"p-4 sm:p-6 max-w-[1600px] mx-auto min-h-screen bg-gray-50",children:[e.jsx("h1",{className:"text-2xl sm:text-3xl font-bold text-gray-800 mb-6 text-center",children:"Gestión de Usuarios"}),S&&e.jsxs("div",{className:"mb-6 p-4 bg-green-100 border-l-4 border-green-500 text-green-700 flex items-center justify-center rounded shadow-sm animate-fade-in-down",children:[e.jsx(oe,{className:"w-5 h-5 mr-2"}),e.jsx("span",{children:S})]}),e.jsxs("div",{className:"bg-white rounded-xl shadow-md overflow-hidden border border-gray-100",children:[e.jsx("div",{className:"p-4 sm:p-6 border-b border-gray-100 flex flex-col md:flex-row justify-between items-center gap-4 bg-gray-50/50",children:e.jsxs("div",{className:"flex flex-col md:flex-row gap-4 w-full md:w-auto flex-1",children:[e.jsxs("form",{className:"relative w-full md:max-w-md",onSubmit:s=>s.preventDefault(),autoComplete:"off",children:[e.jsx("div",{className:"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none",children:e.jsx(I,{className:"h-5 w-5 text-gray-400"})}),e.jsx("input",{type:"search",name:"search_users_query",id:"search_users_query",placeholder:"Buscar por nombre, email o código...",className:"pl-10 pr-4 py-2.5 w-full border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all shadow-sm",value:x,onChange:K,autoComplete:"off"})]}),e.jsxs("select",{className:"w-full md:w-64 px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 shadow-sm bg-white text-gray-700",value:h,onChange:s=>W(s.target.value),children:[e.jsx("option",{value:"",children:"Todos los Vendedores"}),Q.map(s=>e.jsx("option",{value:s,children:s},s))]}),e.jsxs("button",{onClick:re,className:"w-full md:w-auto px-4 py-2.5 bg-green-600 text-white font-medium rounded-lg hover:bg-green-700 transition-colors shadow-sm flex items-center justify-center gap-2",title:"Exportar Lista a Excel",children:[e.jsx(ie,{className:"w-5 h-5"}),e.jsx("span",{className:"hidden md:inline",children:"Exportar Excel"})]})]})}),e.jsx("div",{className:"w-full overflow-hidden",children:e.jsxs("table",{className:"w-full divide-y divide-gray-200 table-fixed",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{scope:"col",className:"w-[30%] px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider truncate",children:"Usuario"}),e.jsx("th",{scope:"col",className:"w-[10%] px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider hidden sm:table-cell truncate",children:"Código"}),e.jsx("th",{scope:"col",className:"w-[20%] px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider hidden md:table-cell truncate",children:"Email"}),e.jsx("th",{scope:"col",className:"w-[15%] px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider hidden lg:table-cell truncate",children:"Vendedor"}),e.jsx("th",{scope:"col",className:"w-[25%] px-4 py-3 text-right text-xs font-semibold text-gray-500 uppercase tracking-wider",children:"Acciones"})]})}),e.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:j.length>0?j.map(s=>e.jsxs("tr",{className:"hover:bg-blue-50/30 transition-colors duration-150",children:[e.jsx("td",{className:"px-4 py-3 overflow-hidden",children:e.jsxs("div",{className:"flex items-center min-w-0",children:[e.jsx("div",{className:"flex-shrink-0 h-9 w-9 hidden xs:block",children:e.jsx("div",{className:"h-9 w-9 rounded-full bg-gradient-to-br from-blue-100 to-blue-200 flex items-center justify-center text-blue-700 font-bold shadow-sm",children:s.full_name?.charAt(0).toUpperCase()||"U"})}),e.jsxs("div",{className:"ml-0 xs:ml-3 min-w-0 flex-1",children:[e.jsx("div",{className:"text-sm font-medium text-gray-900 truncate",title:s.full_name,children:s.full_name}),e.jsx("div",{className:"md:hidden text-xs text-gray-500 truncate",children:s.email})]})]})}),e.jsx("td",{className:"px-4 py-3 whitespace-nowrap hidden sm:table-cell",children:e.jsx("span",{className:"px-2 py-0.5 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800",children:s.a1_cod||"N/A"})}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-500 truncate hidden md:table-cell",title:s.email,children:s.email}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-500 truncate hidden lg:table-cell",title:s.vendedor_nombre,children:s.vendedor_nombre||"-"}),e.jsx("td",{className:"px-4 py-3 text-right text-sm font-medium whitespace-nowrap",children:e.jsxs("div",{className:"flex items-center justify-end gap-1 sm:gap-2",children:[e.jsxs("button",{onClick:()=>Y(s),className:"text-white bg-blue-500 hover:bg-blue-600 font-medium rounded-lg text-xs px-2.5 py-1.5 transition-all shadow-sm focus:outline-none flex items-center gap-1",title:"Ver Análisis",children:[e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",className:"lucide lucide-bar-chart-2",children:[e.jsx("line",{x1:"18",x2:"18",y1:"20",y2:"10"}),e.jsx("line",{x1:"12",x2:"12",y1:"20",y2:"4"}),e.jsx("line",{x1:"6",x2:"6",y1:"20",y2:"14"})]}),e.jsx("span",{className:"hidden xl:inline",children:"Análisis"})]}),e.jsxs("button",{onClick:()=>X(s),className:`text-white font-medium rounded-lg text-xs px-2.5 py-1.5 transition-all shadow-sm focus:outline-none flex items-center justify-center gap-1 ${s.has_password?"bg-indigo-600 hover:bg-indigo-700 focus:ring-4 focus:ring-indigo-300":"bg-green-600 hover:bg-green-700 focus:ring-4 focus:ring-green-300"}`,title:s.has_password?"Resetear":"Asignar",children:[s.has_password?e.jsx(de,{className:"w-3.5 h-3.5"}):e.jsx(ce,{className:"w-3.5 h-3.5"}),e.jsx("span",{className:"hidden xl:inline",children:s.has_password?"Reset":"Asignar"})]}),!s.is_admin&&e.jsx("button",{onClick:()=>se(s),className:"text-white bg-red-500 hover:bg-red-600 font-medium rounded-lg text-xs px-2.5 py-1.5 transition-all shadow-sm focus:outline-none flex items-center gap-1",title:"Eliminar Usuario",children:e.jsx(ue,{className:"w-3.5 h-3.5"})})]})})]},s.id)):e.jsx("tr",{children:e.jsx("td",{colSpan:"5",className:"px-6 py-10 text-center text-gray-500",children:e.jsxs("div",{className:"flex flex-col items-center justify-center",children:[e.jsx(I,{className:"h-10 w-10 text-gray-300 mb-3"}),e.jsx("p",{className:"text-lg font-medium",children:"No se encontraron usuarios"}),e.jsx("p",{className:"text-sm",children:"Intenta con otros filtros o términos de búsqueda."})]})})})})]})})]}),z&&e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center overflow-x-hidden overflow-y-auto outline-none focus:outline-none bg-black/50 backdrop-blur-sm transition-opacity",children:e.jsxs("div",{className:"relative w-full max-w-md mx-4 my-6",children:[e.jsxs("div",{className:"relative flex flex-col w-full bg-white border-0 rounded-xl shadow-2xl outline-none focus:outline-none animate-bounce-in",children:[e.jsxs("div",{className:"flex items-start justify-between p-5 border-b border-solid border-gray-200 rounded-t-xl bg-gray-50",children:[e.jsx("h3",{className:"text-xl font-bold text-gray-800",children:a?.has_password?"Restablecer Contraseña":"Asignar Nueva Contraseña"}),e.jsx("button",{className:"p-1 ml-auto bg-transparent border-0 text-gray-400 hover:text-gray-900 float-right text-3xl leading-none font-semibold outline-none focus:outline-none transition-colors",onClick:v,children:e.jsx("span",{className:"bg-transparent h-6 w-6 text-2xl block outline-none focus:outline-none",children:"×"})})]}),e.jsxs("div",{className:"relative p-6 flex-auto",children:[e.jsxs("p",{className:"my-2 text-gray-600 text-sm leading-relaxed mb-6",children:["Estás restableciendo la contraseña para el usuario:",e.jsx("br",{}),e.jsx("strong",{className:"text-gray-900 block mt-1 text-base",children:a?.full_name})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("input",{type:"text",readOnly:!0,className:"opacity-0 absolute w-0 h-0 -z-10",autoComplete:"username"}),e.jsx("input",{type:"password",readOnly:!0,className:"opacity-0 absolute w-0 h-0 -z-10",autoComplete:"current-password"}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"newPassword",className:"block text-sm font-medium text-gray-700 mb-1",children:"Nueva Contraseña"}),e.jsx("input",{type:"password",id:"newPassword",className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all outline-none",value:d,onChange:s=>D(s.target.value),placeholder:"Ingresa la nueva contraseña"})]}),e.jsx("input",{type:"password",id:"confirmPassword",className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all outline-none",value:T,onChange:s=>O(s.target.value),placeholder:"Repite la nueva contraseña"})]}),e.jsxs("div",{className:"flex items-center mt-2 p-2 bg-gray-50 rounded text-sm text-gray-700",children:[e.jsx("input",{id:"downloadCredentials",type:"checkbox",checked:M,onChange:s=>J(s.target.checked),className:"w-4 h-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500 cursor-pointer"}),e.jsx("label",{htmlFor:"downloadCredentials",className:"ml-2 block cursor-pointer select-none",children:"Descargar credenciales en Excel"})]}),E&&e.jsxs("div",{className:"text-red-600 text-sm bg-red-50 p-2 rounded flex items-start gap-2",children:[e.jsx(me,{className:"w-4 h-4 mt-0.5 flex-shrink-0"}),e.jsx("span",{children:E})]})]})]}),e.jsxs("div",{className:"flex items-center justify-end p-6 border-t border-solid border-gray-200 rounded-b-xl bg-gray-50",children:[e.jsx("button",{className:"text-gray-500 background-transparent font-bold uppercase px-6 py-2 text-sm outline-none focus:outline-none mr-2 mb-1 ease-linear transition-all duration-150 hover:bg-gray-200 rounded-lg",type:"button",onClick:v,children:"Cancelar"}),e.jsx("button",{className:"bg-indigo-600 text-white active:bg-indigo-700 font-bold uppercase text-sm px-6 py-3 rounded-lg shadow hover:shadow-lg outline-none focus:outline-none mr-1 mb-1 ease-linear transition-all duration-150 hover:bg-indigo-700",type:"button",onClick:ee,children:"Guardar Cambios"})]})]})}),e.jsx(xe,{isOpen:G,onClose:Z,userId:F?.id,userName:F?.full_name,isRegularUser:!0}),e.jsx(he,{isOpen:H,onClose:ae,onConfirm:te,title:"Eliminar Usuario",message:`¿Estás seguro de que deseas eliminar al usuario ${g?.full_name}? Esta acción borrará sus credenciales y datos del sistema.`,confirmText:"Eliminar",variant:"danger"})]})};export{ye as default};
