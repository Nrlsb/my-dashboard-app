import{j as e,L as U,a as p}from"./index-BmpGRLHv.js";import{r as a,C as z,a8 as x}from"./ui-libs-Bu6C6VT7.js";import"./vendor-qkC6yhPU.js";const K=()=>{const[l,P]=a.useState([]),[h,g]=a.useState([]),[R,j]=a.useState(!0),[f,N]=a.useState(!1),[u,B]=a.useState(""),[m,G]=a.useState(""),[o,$]=a.useState([]),[b,v]=a.useState(!1),y=a.useRef(null),[i,S]=a.useState(null),[C,k]=a.useState(20),[D,E]=a.useState(!1),[A,_]=a.useState(!1);a.useEffect(()=>{(async()=>{try{j(!0);const r=await p.getProductGroupsForAdmin({params:{onlyWithModifications:!0}}),n=new Map;r.forEach(s=>{s.product_group&&!n.has(s.product_group)&&n.set(s.product_group,{code:s.product_group,name:s.brand||"Sin descripción"})});const c=Array.from(n.values()).sort((s,w)=>s.code.localeCompare(w.code));P(c);const d=await p.getGlobalSetting("price_modified_allowed_groups");if(d&&d.value)try{const s=JSON.parse(d.value);Array.isArray(s)&&g(s)}catch(s){console.error("Failed to parse setting",s)}}catch(r){console.error(r),x.error("Error al cargar datos")}finally{j(!1)}})()},[]),a.useEffect(()=>{const t=r=>{y.current&&!y.current.contains(r.target)&&v(!1)};return document.addEventListener("mousedown",t),()=>document.removeEventListener("mousedown",t)},[]);const O=t=>{g(r=>r.includes(t)?r.filter(n=>n!==t):[...r,t])},L=()=>{g(l.map(t=>t.code))},F=()=>{g([])},M=async()=>{try{N(!0);const t=JSON.stringify(h);await p.updateGlobalSetting("price_modified_allowed_groups",t),x.success("Configuración guardada correctamente")}catch(t){console.error(t),x.error("Error al guardar configuración")}finally{N(!1)}},T=async()=>{if(!u||!m){x.error("Por favor selecciona ambas fechas.");return}try{E(!0),S(null),k(20);const t=o.map(n=>{const c=l.find(d=>d.code===n);return c?c.name:null}).filter(Boolean),r=await p.getPriceChangedProducts({startDate:u,endDate:m+" 23:59:59",brands:t.length>0?t:void 0});S(r)}catch(t){console.error(t),x.error("Error al buscar cambios de precio")}finally{E(!1)}},q=async()=>{if(!u||!m){x.error("Por favor selecciona ambas fechas.");return}try{_(!0);const t=o.map(d=>{const s=l.find(w=>w.code===d);return s?s.name:null}).filter(Boolean),r=await p.downloadPriceChangesExcel({startDate:u,endDate:m+" 23:59:59",brands:t.length>0?t:void 0}),n=window.URL.createObjectURL(new Blob([r])),c=document.createElement("a");c.href=n,c.setAttribute("download",`cambios_precios_${u}.xlsx`),document.body.appendChild(c),c.click(),c.parentNode.removeChild(c)}catch(t){console.error(t),x.error("Error al descargar Excel")}finally{_(!1)}},I=t=>{$(r=>r.includes(t)?r.filter(n=>n!==t):[...r,t])},J=()=>{if(o.length===0)return"Todas las marcas";if(o.length===1){const t=l.find(r=>r.code===o[0]);return t?t.name:o[0]}return`${o.length} marcas seleccionadas`};return R?e.jsx(U,{text:"Cargando grupos..."}):e.jsxs("div",{className:"p-4 md:p-8 w-[95%] mx-auto",children:[e.jsxs("div",{className:"mb-6",children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-800",children:"Alertas de Precio Modificado"}),e.jsxs("p",{className:"text-gray-600 mt-2",children:['Selecciona qué grupos de productos mostrarán la etiqueta "Precio modificado" cuando cambien de precio.',e.jsx("br",{}),e.jsx("span",{className:"text-sm font-semibold text-amber-600",children:"Nota: Si no seleccionas ninguno, se mostrará para TODOS los grupos (comportamiento por defecto)."})]})]}),e.jsxs("div",{className:"bg-white shadow rounded-lg p-6",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsxs("h2",{className:"text-lg font-semibold",children:["Grupos de Productos (",l.length,")"]}),e.jsxs("div",{className:"space-x-2",children:[e.jsx("button",{onClick:L,className:"text-sm text-blue-600 hover:text-blue-800 font-medium",children:"Seleccionar Todos"}),e.jsx("span",{className:"text-gray-300",children:"|"}),e.jsx("button",{onClick:F,className:"text-sm text-gray-600 hover:text-gray-800 font-medium",children:"Limpiar Selección"})]})]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 max-h-[60vh] overflow-y-auto mb-6 border p-4 rounded bg-gray-50",children:l.map(t=>e.jsxs("label",{className:"flex items-center space-x-3 p-2 hover:bg-white rounded cursor-pointer transition-colors",children:[e.jsx("input",{type:"checkbox",className:"h-5 w-5 text-blue-600 rounded border-gray-300 focus:ring-blue-500",checked:h.includes(t.code),onChange:()=>O(t.code)}),e.jsxs("span",{className:"text-gray-700 text-sm font-medium truncate",title:`${t.code} - ${t.name}`,children:[e.jsx("span",{className:"font-bold text-gray-500 mr-2",children:t.code}),t.name]})]},t.code))}),e.jsxs("div",{className:"flex justify-between items-center border-t pt-4",children:[e.jsx("div",{className:"text-sm text-gray-500",children:h.length===0?"Ningún grupo seleccionado (Se mostrará alerta en TODOS los productos)":`${h.length} grupos seleccionados`}),e.jsx("button",{onClick:M,disabled:f,className:`px-6 py-2 rounded-md text-white font-medium transition-colors ${f?"bg-blue-400 cursor-not-allowed":"bg-blue-600 hover:bg-blue-700"}`,children:f?"Guardando...":"Guardar Configuración"})]})]}),e.jsxs("div",{className:"mt-8 bg-white shadow rounded-lg p-6",children:[e.jsx("h2",{className:"text-lg font-semibold mb-4",children:"Reporte de Cambios de Precio"}),e.jsxs("div",{className:"flex flex-col md:flex-row gap-4 mb-6 items-start",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Fecha Desde"}),e.jsx("input",{type:"date",className:"border rounded p-2 w-full",value:u,onChange:t=>B(t.target.value)})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Fecha Hasta"}),e.jsx("input",{type:"date",className:"border rounded p-2 w-full",value:m,onChange:t=>G(t.target.value)})]}),e.jsxs("div",{className:"flex-1 min-w-[200px] relative",ref:y,children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Marcas (Opcional)"}),e.jsxs("button",{type:"button",onClick:()=>v(!b),className:"w-full flex justify-between items-center text-left bg-white px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 cursor-pointer h-[42px]",children:[e.jsx("span",{className:"truncate text-sm text-gray-700",children:J()}),e.jsx(z,{className:`w-5 h-5 text-gray-400 transition-transform ${b?"rotate-180":""}`})]}),b&&e.jsx("div",{className:"absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto",children:l.map(t=>e.jsxs("label",{className:"flex items-center px-4 py-2 hover:bg-gray-100 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:o.includes(t.code),onChange:()=>I(t.code),className:"h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"}),e.jsx("span",{className:"ml-3 text-sm text-gray-700 truncate",title:t.name,children:t.name})]},t.code))})]})]}),e.jsxs("div",{className:"flex gap-2 mb-6",children:[e.jsx("button",{onClick:T,disabled:D,className:"bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700 transition disabled:opacity-50",children:D?"Buscando...":"Buscar Cambios"}),i&&i.length>0&&e.jsx("button",{onClick:q,disabled:A,className:"bg-green-600 text-white px-6 py-2 rounded hover:bg-green-700 transition disabled:opacity-50 flex items-center gap-2",children:A?"Descargando...":"Descargar Excel"})]}),i&&e.jsxs("div",{className:"overflow-x-auto",children:[e.jsxs("div",{className:"mb-2 text-sm text-gray-500",children:["Encontrados: ",i.length," productos"]}),e.jsxs("table",{className:"min-w-full divide-y divide-gray-200 border",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Código"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Descripción"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Marca"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Fecha"}),e.jsx("th",{className:"px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider",children:"P. Anterior"}),e.jsx("th",{className:"px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider",children:"P. Actual"}),e.jsx("th",{className:"px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Dif ($)"}),e.jsx("th",{className:"px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Dif (%)"})]})}),e.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:i.length>0?i.slice(0,C).map((t,r)=>e.jsxs("tr",{children:[e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900",children:t.code}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500",children:t.description}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500",children:t.brand}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500",children:t.change_date_formatted}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-right text-gray-400",children:t.previous_price?new Intl.NumberFormat("es-AR",{style:"currency",currency:"ARS"}).format(t.previous_price):"-"}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-medium text-right",children:new Intl.NumberFormat("es-AR",{style:"currency",currency:"ARS"}).format(t.current_price)}),e.jsx("td",{className:`px-6 py-4 whitespace-nowrap text-sm text-right ${t.diff>0?"text-red-600":"text-green-600"}`,children:t.diff?new Intl.NumberFormat("es-AR",{style:"currency",currency:"ARS"}).format(t.diff):"-"}),e.jsx("td",{className:`px-6 py-4 whitespace-nowrap text-sm text-right ${t.percent>0?"text-red-600":"text-green-600"}`,children:t.percent?t.percent.toFixed(2)+"%":"-"})]},`${t.code}-${r}`)):e.jsx("tr",{children:e.jsx("td",{colSpan:"8",className:"px-6 py-4 text-center text-sm text-gray-500",children:"No se encontraron cambios de precio en este rango."})})})]}),i.length>C&&e.jsx("div",{className:"mt-4 flex justify-center",children:e.jsx("button",{onClick:()=>k(t=>t+20),className:"bg-gray-100 text-gray-700 px-6 py-2 rounded-full hover:bg-gray-200 transition font-medium border border-gray-300",children:"Cargar más productos"})})]})]})]})};export{K as default};
