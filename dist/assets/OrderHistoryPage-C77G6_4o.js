import{u as k,b as E,f as B,c as V,j as e,L as _,a as j}from"./index-425XPhkP.js";import{r as n,v as T,l as $,n as R}from"./ui-libs-xkhqbQ7p.js";import{u as F}from"./useMutation-D8chnLoC.js";import{C as w}from"./CustomSelect-G7SxHh6q.js";import{N as H}from"./NotificationModal-Du1quDf6.js";import"./vendor-qkC6yhPU.js";function Q(){const m=k(),{user:o}=E(),r=o?.role==="vendedor",v=B(),[p,g]=n.useState({}),[u,b]=n.useState({}),[h,C]=n.useState(""),[c,S]=n.useState(""),[l,x]=n.useState({isOpen:!1,title:"",message:"",variant:"info"}),f=(t,s)=>{g(a=>({...a,[t]:s}))},y=(t,s)=>{b(a=>({...a,[t]:s}))},{data:d,isLoading:O,error:N}=V({queryKey:["orderHistory",o.id],queryFn:()=>j.fetchOrderHistory(),staleTime:1e3*60*5,enabled:!!o?.id});n.useEffect(()=>{if(d){const t={},s={};d.forEach(a=>{s[a.id]=a.vendorSalesOrderNumber||"",t[a.id]=a.status}),g(s),b(t)}},[d]);const P=F({mutationFn:t=>j.updateOrderDetails(t),onSuccess:()=>{x({isOpen:!0,title:"Éxito",message:"Cambios guardados exitosamente!",variant:"success"}),v.invalidateQueries(["orderHistory",o.id])},onError:t=>{x({isOpen:!0,title:"Error",message:"Error al guardar los cambios: "+t.message,variant:"error"})}}),D=()=>{const t=d.map(a=>({id:a.id,vendorSalesOrderNumber:p[a.id],status:u[a.id]})),s=t.find(a=>a.status==="Confirmado"&&!a.vendorSalesOrderNumber?.trim());if(s){x({isOpen:!0,title:"Atención",message:`Para confirmar el pedido #${s.id}, debes ingresar el Nº de Pedido Venta.`,variant:"info"});return}P.mutate(t)},i=d?.filter(t=>{const s=h?t.status===h:!0,a=c?t.client_name&&t.client_name.toLowerCase().includes(c.toLowerCase())||String(t.id).includes(c):!0;return s&&a})||[];return O?e.jsx(_,{text:"Cargando historial..."}):N?e.jsxs("div",{children:["Error al cargar el historial: ",N.message]}):e.jsxs("div",{className:"container mx-auto p-4 md:p-8 min-h-screen bg-gray-50",children:[e.jsx("h2",{className:"text-2xl sm:text-3xl font-bold text-gray-800 mb-6 border-b-2 border-gray-200 pb-2",children:"Historial de Pedidos"}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-3 sm:gap-4 mb-6 items-center",children:[e.jsx("button",{onClick:()=>m("/dashboard"),className:"flex-grow sm:flex-grow-0 w-full sm:w-auto px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 transition-colors duration-200 font-semibold cursor-pointer",children:"Volver al Dashboard"}),r&&e.jsx("button",{onClick:D,className:"flex-grow sm:flex-grow-0 w-full sm:w-auto px-4 py-2 bg-espint-green text-white rounded-md hover:bg-green-600 transition-colors duration-200 font-semibold cursor-pointer",children:"Guardar Cambios"})]}),r&&e.jsxs("div",{className:"bg-white p-4 rounded-lg shadow-md my-5 flex flex-col sm:flex-row gap-4 items-center",children:[e.jsx("input",{type:"text",placeholder:"Buscar por Cliente o ID de Pedido",value:c,onChange:t=>S(t.target.value),className:"py-2 px-3 border border-gray-300 rounded-md text-base min-w-[200px] w-full sm:w-auto focus:ring-blue-500 focus:border-blue-500"}),e.jsx("div",{className:"relative w-full md:w-64",children:e.jsx(w,{options:["Pendiente","Confirmado","Cancelado"],value:h,onChange:t=>C(t),placeholder:"Todos los Estados"})})]}),e.jsxs("div",{className:"mt-8",children:[e.jsx("div",{className:"md:hidden space-y-4",children:i&&i.length>0?i.map(t=>e.jsxs("div",{className:"bg-white rounded-lg shadow-sm border border-gray-100 p-4",children:[e.jsxs("div",{className:"flex justify-between items-start mb-2",children:[e.jsxs("span",{className:"text-lg font-bold text-[#183B64]",children:["#",t.id]}),e.jsx("span",{className:`px-2 py-1 rounded-full text-xs font-semibold
                      ${t.status==="Pendiente"?"bg-yellow-100 text-yellow-800":""}
                      ${t.status==="Confirmado"?"bg-green-100 text-green-800":""}
                      ${t.status==="Cancelado"||t.status==="Rechazado"?"bg-red-100 text-red-800":""}
                      ${["Pendiente","Confirmado","Cancelado","Rechazado"].includes(t.status)?"":"bg-gray-100 text-gray-800"}
                    `,children:t.status})]}),r&&e.jsxs("div",{className:"mb-3 text-sm font-medium text-gray-700",children:[e.jsx("span",{className:"text-gray-500 mr-1",children:"Cliente:"}),t.client_code," - ",t.client_name]}),e.jsxs("div",{className:"flex items-center gap-4 mb-4 text-sm text-gray-600",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(T,{className:"w-4 h-4"}),e.jsx("span",{children:t.formatted_date})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx($,{className:"w-4 h-4"}),e.jsxs("span",{children:[t.item_count," Items"]})]})]}),!r&&t.status==="Confirmado"&&t.vendorSalesOrderNumber&&e.jsxs("div",{className:"mb-3 text-sm font-medium text-gray-700",children:[e.jsx("span",{className:"text-gray-500 mr-1",children:"N° Pedido Venta:"}),"#",t.vendorSalesOrderNumber]}),r&&e.jsxs("div",{className:"mb-4 space-y-3 bg-gray-50 p-3 rounded-md",children:[e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx("label",{className:"text-xs font-semibold text-gray-500",children:"N° Pedido Venta"}),e.jsx("input",{type:"text",value:p[t.id]||"",onChange:s=>f(t.id,s.target.value),placeholder:"N° Pedido",className:"p-2 border border-gray-300 rounded-md text-sm w-full"})]}),e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx("label",{className:"text-xs font-semibold text-gray-500",children:"Estado del Pedido"}),e.jsx(w,{options:["Pendiente","Confirmado","Cancelado"],value:u[t.id]||"",onChange:s=>y(t.id,s),placeholder:"Seleccionar"})]})]}),e.jsxs("div",{className:"flex justify-between items-center pt-3 border-t border-gray-100",children:[e.jsx("span",{className:"text-lg font-bold text-gray-900",children:t.formattedTotal}),e.jsxs("button",{onClick:()=>m(`/order-detail/${t.id}`),className:"flex items-center text-sm font-medium text-espint-blue hover:text-blue-700 transition-colors",children:["Ver Detalle",e.jsx(R,{className:"w-4 h-4 ml-1"})]})]})]},t.id)):e.jsx("p",{className:"p-4 text-gray-500 text-center bg-white rounded-lg shadow-sm",children:"No tienes pedidos en tu historial."})}),e.jsx("div",{className:"hidden md:block overflow-x-auto bg-white rounded-lg shadow-lg",children:i&&i.length>0?e.jsxs("table",{className:"min-w-full divide-y divide-gray-200 table-collapse",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{scope:"col",className:"px-4 py-3 text-left text-xs font-semibold text-white uppercase tracking-wider border-b border-gray-200 bg-[#0B3D68]",children:"ID Pedido"}),e.jsx("th",{scope:"col",className:"px-4 py-3 text-left text-xs font-semibold text-white uppercase tracking-wider border-b border-gray-200 bg-[#0B3D68]",children:"Fecha"}),r&&e.jsx("th",{scope:"col",className:"px-4 py-3 text-left text-xs font-semibold text-white uppercase tracking-wider border-b border-gray-200 bg-[#0B3D68]",children:"Cliente"}),e.jsx("th",{scope:"col",className:"px-4 py-3 text-left text-xs font-semibold text-white uppercase tracking-wider border-b border-gray-200 bg-[#0B3D68]",children:"Total"}),e.jsx("th",{scope:"col",className:"px-4 py-3 text-left text-xs font-semibold text-white uppercase tracking-wider border-b border-gray-200 bg-[#0B3D68]",children:"Estado"}),e.jsx("th",{scope:"col",className:"px-4 py-3 text-center text-xs font-semibold text-white uppercase tracking-wider border-b border-gray-200 bg-[#0B3D68]",children:"Cant. Items"}),e.jsx("th",{scope:"col",className:"px-4 py-3 text-center text-xs font-semibold text-white uppercase tracking-wider border-b border-gray-200 bg-[#0B3D68]",children:"N° Pedido Venta"}),r&&e.jsx("th",{scope:"col",className:"px-4 py-3 text-center text-xs font-semibold text-white uppercase tracking-wider border-b border-gray-200 bg-[#0B3D68]",children:"Estado del Pedido"}),e.jsx("th",{scope:"col",className:"px-4 py-3 text-center text-xs font-semibold text-white uppercase tracking-wider border-b border-gray-200 bg-[#0B3D68]",children:"Acciones"})]})}),e.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:i.map(t=>e.jsxs("tr",{className:"hover:bg-gray-50",children:[e.jsxs("td",{className:"px-4 py-3 whitespace-nowrap text-sm text-gray-800 font-mono",children:["#",t.id]}),e.jsx("td",{className:"px-4 py-3 whitespace-nowrap text-sm text-gray-800",children:t.formatted_date}),r&&e.jsxs("td",{className:"px-4 py-3 whitespace-nowrap text-sm text-gray-800 font-medium",children:[t.client_code," - ",t.client_name]}),e.jsx("td",{className:"px-4 py-3 whitespace-nowrap text-sm text-gray-800 font-mono",children:t.formattedTotal}),e.jsx("td",{className:"px-4 py-3 whitespace-nowrap text-sm text-gray-800",children:t.status}),e.jsx("td",{className:"px-4 py-3 whitespace-nowrap text-sm text-gray-800 text-center",children:t.item_count}),e.jsx("td",{className:"px-4 py-3 whitespace-nowrap text-sm text-gray-800 text-center",children:r?e.jsx("input",{type:"text",value:p[t.id]||"",onChange:s=>f(t.id,s.target.value),placeholder:"N° Pedido",className:"p-1 border border-gray-300 rounded-md w-24 text-center text-sm"}):e.jsx("span",{className:"font-mono font-medium text-gray-700",children:t.status==="Confirmado"&&t.vendorSalesOrderNumber?`#${t.vendorSalesOrderNumber}`:"-"})}),r&&e.jsx("td",{className:"px-4 py-3 whitespace-nowrap text-sm text-gray-800 text-center",children:e.jsxs("select",{value:u[t.id]||"",onChange:s=>y(t.id,s.target.value),className:"p-1 border border-gray-300 rounded-md text-center text-sm w-32",children:[e.jsx("option",{value:"Pendiente",children:"Pendiente"}),e.jsx("option",{value:"Rechazado",children:"Rechazado"}),e.jsx("option",{value:"Confirmado",children:"Confirmado"})]})}),e.jsx("td",{className:"px-4 py-3 whitespace-nowrap text-right text-sm font-medium text-center",children:e.jsx("button",{onClick:()=>m(`/order-detail/${t.id}`),className:"inline-flex items-center px-3 py-1.5 border border-espint-blue text-xs font-medium rounded-md shadow-sm text-espint-blue bg-transparent hover:bg-espint-blue hover:text-white focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-espint-blue transition-colors duration-200 cursor-pointer",children:"Ver Detalle"})})]},t.id))})]}):e.jsx("p",{className:"p-4 text-gray-500",children:"No tienes pedidos en tu historial."})})]}),e.jsx(H,{isOpen:l.isOpen,onClose:()=>x({...l,isOpen:!1}),title:l.title,message:l.message,variant:l.variant})]})}export{Q as default};
